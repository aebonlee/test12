<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>평가보고서 초안 확인 | ValueLink</title>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 모바일 최적화 CSS -->
    <link rel="stylesheet" href="../styles/mobile-optimize.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --deep-blue: #1D4ED8;
            --deep-green: #166534;
            --light-green: #DCFCE7;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --white: #FFFFFF;
            --border: #E5E7EB;
            --bg-light: #F9FAFB;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --cover-blue: #1E3A5F;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            gap: 40px;
        }

        .main-content { flex: 1; min-width: 0; }

        .page-header { margin-bottom: 32px; }
        .page-title { font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .page-description { font-size: 16px; color: var(--text-secondary); line-height: 1.6; }

        /* ====== 보고서 문서 영역 ====== */
        .report-document {
            background: white;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        /* 워터마크 (초안) */
        .report-document::before {
            content: '초안 DRAFT';
            position: fixed;
            top: 50%;
            left: calc(50% - 160px);
            transform: translate(-50%, -50%) rotate(-35deg);
            font-size: 80px;
            font-weight: 900;
            color: rgba(29, 78, 216, 0.06);
            white-space: nowrap;
            pointer-events: none;
            z-index: 10;
            letter-spacing: 8px;
        }

        /* ====== 표지 (Cover) ====== */
        .report-cover {
            background: linear-gradient(135deg, var(--cover-blue) 0%, #2C5282 100%);
            color: white;
            padding: 80px 60px;
            text-align: center;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .cover-draft-badge {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .cover-logo {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 4px;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 40px;
        }

        .cover-title {
            font-size: 36px;
            font-weight: 800;
            line-height: 1.3;
            margin-bottom: 16px;
        }

        .cover-subtitle {
            font-size: 18px;
            font-weight: 400;
            opacity: 0.85;
            margin-bottom: 48px;
        }

        .cover-company {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 48px;
            padding: 16px 40px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
        }

        .cover-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 48px;
            text-align: left;
            font-size: 14px;
        }

        .cover-info-item { display: flex; gap: 8px; }
        .cover-info-label { opacity: 0.6; min-width: 80px; }
        .cover-info-value { font-weight: 600; }

        .cover-report-no {
            margin-top: 40px;
            font-size: 13px;
            opacity: 0.5;
            letter-spacing: 1px;
        }

        /* ====== 목차 네비게이션 ====== */
        .report-toc {
            padding: 40px 60px;
            border-bottom: 2px solid var(--border);
        }

        .toc-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--cover-blue);
            display: inline-block;
        }

        .toc-list { list-style: none; }

        .toc-item {
            padding: 10px 0;
            border-bottom: 1px dotted #D1D5DB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toc-item a {
            text-decoration: none;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .toc-item a:hover { color: var(--deep-blue); }

        .toc-item .toc-number {
            color: var(--cover-blue);
            font-weight: 700;
            margin-right: 12px;
        }

        /* ====== 공통 섹션 스타일 ====== */
        .report-section {
            padding: 48px 60px;
            border-bottom: 1px solid var(--border);
            page-break-inside: avoid;
        }

        .report-section:last-child { border-bottom: none; }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 3px solid var(--cover-blue);
        }

        .section-number {
            background: var(--cover-blue);
            color: white;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-content {
            font-size: 14px;
            color: #374151;
            line-height: 1.9;
            white-space: pre-line;
        }

        .section-content p {
            margin-bottom: 12px;
        }

        .section-empty {
            color: var(--text-secondary);
            font-style: italic;
            padding: 20px;
            background: #F9FAFB;
            border-radius: 8px;
            text-align: center;
        }

        /* 면책조항 */
        .disclaimer {
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-top: 16px;
        }

        /* ====== 액션 영역 ====== */
        .action-area {
            max-width: 800px;
            margin: 32px auto 0;
        }

        .notice-box {
            padding: 16px 20px;
            background: #DBEAFE;
            border-left: 4px solid var(--deep-blue);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .notice-box strong {
            display: block;
            font-size: 15px;
            color: var(--deep-blue);
            margin-bottom: 8px;
        }

        .notice-box ul {
            margin-left: 20px;
            font-size: 14px;
            color: #1E40AF;
            line-height: 1.8;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .btn-revision {
            flex: 1;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 700;
            color: var(--warning);
            background: #FEF3C7;
            border: 2px solid var(--warning);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-revision:hover {
            background: var(--warning);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-confirm {
            flex: 1;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            background: var(--deep-green);
            border: 2px solid var(--deep-green);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-confirm:hover {
            background: #15803D;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 101, 52, 0.3);
        }

        .btn-confirm:disabled {
            background: #9CA3AF;
            border-color: #9CA3AF;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ====== 상태 메시지 ====== */
        .status-message {
            max-width: 800px;
            margin: 60px auto;
            text-align: center;
            padding: 60px 40px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        }

        .status-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .status-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .status-desc {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ====== 로딩 ====== */
        .loading { text-align: center; padding: 60px 20px; }
        .loading-spinner {
            width: 48px; height: 48px;
            border: 4px solid #E5E7EB;
            border-top-color: var(--deep-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 15px; color: var(--text-secondary); }

        /* ====== 인쇄 스타일 ====== */
        @media print {
            body { background: white; }
            .container { padding: 0; max-width: 100%; }
            .page-header { display: none; }
            .action-area { display: none; }
            .report-document {
                box-shadow: none;
                max-width: 100%;
            }
            .report-document::before { display: none; }
            .report-cover { min-height: auto; padding: 60px 40px; page-break-after: always; }
            .report-toc { page-break-after: always; }
            .report-section { padding: 32px 40px; page-break-inside: avoid; }
        }

        /* ====== 반응형 ====== */
        @media (max-width: 1024px) {
            .container { flex-direction: column; padding: 20px; }
            .report-document::before { font-size: 50px; left: 50%; }
        }

        @media (max-width: 768px) {
            .report-cover { padding: 40px 24px; min-height: 400px; }
            .cover-title { font-size: 24px; }
            .cover-company { font-size: 20px; padding: 12px 24px; }
            .cover-info-grid { grid-template-columns: 1fr; }
            .report-section { padding: 32px 24px; }
            .report-toc { padding: 32px 24px; }
            .section-header { flex-wrap: wrap; }
            .section-title { font-size: 18px; }
            .action-buttons { flex-direction: column; }
            .status-message { margin: 30px 16px; padding: 40px 24px; }
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <div id="header-container"></div>

    <div class="container">
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">평가보고서 초안</h1>
                <p class="page-description">평가보고서 초안이 준비되었습니다. 내용을 확인하시고, 수정이 필요하면 수정 요청을 해주세요.</p>
            </div>

            <!-- 로딩 상태 -->
            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                <p class="loading-text">평가보고서 초안을 불러오는 중...</p>
            </div>

            <!-- 미준비 상태 -->
            <div id="notReadyState" style="display: none;">
                <div class="status-message">
                    <div class="status-icon">&#128221;</div>
                    <div class="status-title">초안이 아직 준비되지 않았습니다</div>
                    <div class="status-desc">
                        담당 공인회계사가 평가보고서 초안을 작성 중입니다.<br>
                        초안이 제출되면 이 페이지에서 확인하실 수 있습니다.
                    </div>
                </div>
            </div>

            <!-- 이미 확인 완료 상태 -->
            <div id="confirmedState" style="display: none;">
                <div class="status-message">
                    <div class="status-icon">&#9989;</div>
                    <div class="status-title">초안 확인이 완료되었습니다</div>
                    <div class="status-desc">
                        최종 보고서 작성이 진행 중입니다.<br>
                        담당 공인회계사가 최종 보고서를 준비하고 있으며, 완료 시 알림을 보내드립니다.
                    </div>
                    <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <a id="confirmedGoFinal" href="#" style="display: inline-block; padding: 12px 28px; background: #1D4ED8; color: white; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 15px;">최종 보고서 확인</a>
                        <a href="../dashboard.html" style="display: inline-block; padding: 12px 28px; background: #F3F4F6; color: #374151; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 15px;">대시보드로 이동</a>
                    </div>
                </div>
            </div>

            <!-- 메인 컨텐츠 (로딩 후 표시) -->
            <div id="mainContent" style="display: none;">

                <!-- ===== 보고서 문서 ===== -->
                <div class="report-document">

                    <!-- 1. 표지 (Cover) -->
                    <div class="report-cover" id="sectionCover">
                        <div class="cover-draft-badge">DRAFT</div>
                        <div class="cover-logo">VALUELINK</div>
                        <div class="cover-title">기업가치 평가보고서</div>
                        <div class="cover-subtitle" id="coverMethodName">(초안)</div>
                        <div class="cover-company" id="coverCompanyName">-</div>
                        <div class="cover-info-grid">
                            <div class="cover-info-item">
                                <span class="cover-info-label">평가기준일</span>
                                <span class="cover-info-value" id="coverBaseDate">-</span>
                            </div>
                            <div class="cover-info-item">
                                <span class="cover-info-label">평가기관</span>
                                <span class="cover-info-value">ValueLink</span>
                            </div>
                            <div class="cover-info-item">
                                <span class="cover-info-label">작성일</span>
                                <span class="cover-info-value" id="coverWriteDate">-</span>
                            </div>
                            <div class="cover-info-item">
                                <span class="cover-info-label">평가방법</span>
                                <span class="cover-info-value" id="coverMethod">-</span>
                            </div>
                        </div>
                        <div class="cover-report-no" id="coverReportNo">-</div>
                    </div>

                    <!-- 목차 -->
                    <div class="report-toc">
                        <div class="toc-title">목 차</div>
                        <ul class="toc-list">
                            <li class="toc-item"><a href="#sec1"><span class="toc-number">I.</span> 요약 (Executive Summary)</a></li>
                            <li class="toc-item"><a href="#sec2"><span class="toc-number">II.</span> 평가 개요</a></li>
                            <li class="toc-item"><a href="#sec3"><span class="toc-number">III.</span> 회사 개요 및 산업 분석</a></li>
                            <li class="toc-item"><a href="#sec4"><span class="toc-number">IV.</span> 재무 분석</a></li>
                            <li class="toc-item"><a href="#sec5"><span class="toc-number">V.</span> 평가 방법론 및 가정</a></li>
                            <li class="toc-item"><a href="#sec6"><span class="toc-number">VI.</span> 평가 결과</a></li>
                            <li class="toc-item"><a href="#sec7"><span class="toc-number">VII.</span> 민감도 분석</a></li>
                            <li class="toc-item"><a href="#sec8"><span class="toc-number">VIII.</span> 결론</a></li>
                            <li class="toc-item"><a href="#sec9"><span class="toc-number">IX.</span> 부록</a></li>
                        </ul>
                    </div>

                    <!-- 섹션 1: 요약 -->
                    <div class="report-section" id="sec1">
                        <div class="section-header">
                            <div class="section-number">I</div>
                            <div class="section-title">요약 (Executive Summary)</div>
                        </div>
                        <div class="section-content" id="content-summary"></div>
                    </div>

                    <!-- 섹션 2: 평가 개요 -->
                    <div class="report-section" id="sec2">
                        <div class="section-header">
                            <div class="section-number">II</div>
                            <div class="section-title">평가 개요</div>
                        </div>
                        <div class="section-content" id="content-overview"></div>
                    </div>

                    <!-- 섹션 3: 회사 개요 및 산업 분석 -->
                    <div class="report-section" id="sec3">
                        <div class="section-header">
                            <div class="section-number">III</div>
                            <div class="section-title">회사 개요 및 산업 분석</div>
                        </div>
                        <div class="section-content" id="content-company"></div>
                    </div>

                    <!-- 섹션 4: 재무 분석 -->
                    <div class="report-section" id="sec4">
                        <div class="section-header">
                            <div class="section-number">IV</div>
                            <div class="section-title">재무 분석</div>
                        </div>
                        <div class="section-content" id="content-financial"></div>
                    </div>

                    <!-- 섹션 5: 평가 방법론 및 가정 -->
                    <div class="report-section" id="sec5">
                        <div class="section-header">
                            <div class="section-number">V</div>
                            <div class="section-title">평가 방법론 및 가정</div>
                        </div>
                        <div class="section-content" id="content-methodology"></div>
                    </div>

                    <!-- 섹션 6: 평가 결과 -->
                    <div class="report-section" id="sec6">
                        <div class="section-header">
                            <div class="section-number">VI</div>
                            <div class="section-title">평가 결과</div>
                        </div>
                        <div class="section-content" id="content-results"></div>
                    </div>

                    <!-- 섹션 7: 민감도 분석 -->
                    <div class="report-section" id="sec7">
                        <div class="section-header">
                            <div class="section-number">VII</div>
                            <div class="section-title">민감도 분석</div>
                        </div>
                        <div class="section-content" id="content-sensitivity"></div>
                    </div>

                    <!-- 섹션 8: 결론 -->
                    <div class="report-section" id="sec8">
                        <div class="section-header">
                            <div class="section-number">VIII</div>
                            <div class="section-title">결론</div>
                        </div>
                        <div class="section-content" id="content-conclusion"></div>
                    </div>

                    <!-- 섹션 9: 부록 -->
                    <div class="report-section" id="sec9">
                        <div class="section-header">
                            <div class="section-number">IX</div>
                            <div class="section-title">부록</div>
                        </div>
                        <div class="section-content" id="content-appendix"></div>
                        <div class="disclaimer" style="margin-top: 32px;">
                            본 보고서는 의뢰인이 제공한 자료와 공개 정보를 기초로 작성되었으며, 제공된 자료의 정확성에 대한 책임은 의뢰인에게 있습니다.
                            본 평가 결과는 평가기준일 현재의 시장 상황과 가용 정보를 기반으로 한 것이며, 추후 시장 상황 변화에 따라 기업가치가 변동될 수 있습니다.
                            본 보고서는 특정 거래의 권유 또는 투자 조언을 목적으로 작성된 것이 아니며, 보고서 이용에 따른 결과에 대하여 평가기관은 법적 책임을 부담하지 않습니다.
                        </div>
                    </div>

                </div>
                <!-- /보고서 문서 -->

                <!-- 액션 영역 -->
                <div class="action-area">
                    <div class="notice-box">
                        <strong>안내사항</strong>
                        <ul>
                            <li>본 보고서는 <strong>초안</strong>이며, 수정 요청 후 최종안이 작성됩니다.</li>
                            <li>수정이 필요하시면 '수정 요청하기' 버튼을 눌러주세요.</li>
                            <li>초안 확인이 완료되면 '확인 완료' 버튼을 눌러주세요.</li>
                            <li>확인 완료 후 최종 보고서 작성이 진행됩니다.</li>
                        </ul>
                    </div>
                    <div class="action-buttons">
                        <a href="#" id="btnRevision" class="btn-revision">수정 요청하기</a>
                        <button id="btnConfirm" class="btn-confirm">확인 완료</button>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- 헤더 로드 -->
    <script>
        fetch('../../components/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
                const scripts = document.getElementById('header-container').querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) { newScript.src = script.src; }
                    else { newScript.textContent = script.textContent; }
                    document.body.appendChild(newScript);
                });
            })
            .catch(error => console.error('헤더 로드 실패:', error));
    </script>

    <!-- 페이지 스크립트 -->
    <script>
        // ====== Supabase 초기화 ======
        const SUPABASE_URL = 'https://arxrfetgaitkgiiqabap.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeHJmZXRnYWl0a2dpaXFhYmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNzIxNDMsImV4cCI6MjA2Mjk0ODE0M30.aGSJFVFW5P_E9l4sBz5_7MWJiN5YOhMJXBbLPi7bo0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const METHOD_NAMES = {
            dcf: 'DCF평가법',
            relative: '상대가치평가법',
            intrinsic: '본질가치평가법',
            asset: '자산가치평가법',
            inheritance_tax: '상증세법평가법'
        };

        const METHOD_FULL_NAMES = {
            dcf: 'DCF평가법 (현금흐름할인법)',
            relative: '상대가치평가법 (유사기업비교법)',
            intrinsic: '본질가치평가법',
            asset: '자산가치평가법 (순자산가치법)',
            inheritance_tax: '상증세법평가법 (상속세및증여세법)'
        };

        const SECTION_KEYS = [
            'summary', 'overview', 'company', 'financial',
            'methodology', 'results', 'sensitivity', 'conclusion', 'appendix'
        ];

        // ====== URL 파라미터 ======
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId') || urlParams.get('id');
        const method = urlParams.get('method');

        // ====== 상태 표시 함수 ======
        function showState(stateId) {
            ['loadingState', 'notReadyState', 'confirmedState', 'mainContent'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(stateId).style.display = stateId === 'mainContent' ? 'block' : '';
        }

        // ====== 페이지 초기화 ======
        async function initializePage() {
            if (!projectId || !method) {
                showState('notReadyState');
                document.querySelector('#notReadyState .status-title').textContent = '잘못된 접근입니다';
                document.querySelector('#notReadyState .status-desc').textContent = '프로젝트 ID 또는 평가법 정보가 없습니다.';
                return;
            }

            try {
                // 1. 프로젝트 정보 조회
                const { data: project, error: projError } = await supabase
                    .from('projects')
                    .select('project_id, company_name, valuation_date')
                    .eq('project_id', projectId)
                    .single();

                if (projError) {
                    console.error('프로젝트 조회 오류:', projError);
                    showState('notReadyState');
                    document.querySelector('#notReadyState .status-title').textContent = '프로젝트를 찾을 수 없습니다';
                    document.querySelector('#notReadyState .status-desc').textContent = `프로젝트 ID: ${projectId}`;
                    return;
                }

                // draft_method_status에서 방법별 상태 확인
                const { data: methodStatus } = await supabase
                    .from('draft_method_status')
                    .select('draft_status, draft_submitted_at, final_report_url')
                    .eq('project_id', projectId)
                    .eq('method', method)
                    .maybeSingle();
                const status = methodStatus ? methodStatus.draft_status : 'not_started';

                // 아직 초안이 제출되지 않은 경우
                if (status === 'not_started' || status === 'in_progress') {
                    showState('notReadyState');
                    return;
                }

                // 이미 확인 완료된 경우
                if (status === 'confirmed' || status === 'finalized') {
                    showState('confirmedState');
                    document.getElementById('confirmedGoFinal').href = 'report-final.html?projectId=' + encodeURIComponent(projectId) + '&method=' + encodeURIComponent(method);
                    return;
                }

                // submitted 또는 revision_requested → 초안 표시
                // 2. 섹션 내용 로드
                const { data: sections, error: secError } = await supabase
                    .from('report_draft_sections')
                    .select('*')
                    .eq('project_id', projectId)
                    .eq('method', method);

                if (secError) {
                    console.error('섹션 로드 오류:', secError);
                    showState('notReadyState');
                    document.querySelector('#notReadyState .status-title').textContent = '보고서를 불러올 수 없습니다';
                    document.querySelector('#notReadyState .status-desc').innerHTML = '오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                    return;
                }

                // 섹션 데이터를 key로 매핑
                const sectionMap = {};
                (sections || []).forEach(s => {
                    sectionMap[s.section_key] = s;
                });

                // 3. 표지 렌더링
                renderCover(project, method);

                // 4. 섹션 내용 렌더링
                renderSections(sectionMap);

                // 5. 버튼 설정
                setupButtons(project);

                // 6. 표시
                showState('mainContent');

            } catch (err) {
                console.error('페이지 초기화 오류:', err);
                showState('notReadyState');
                document.querySelector('#notReadyState .status-title').textContent = '오류가 발생했습니다';
                document.querySelector('#notReadyState .status-desc').textContent = err.message;
            }
        }

        // ====== 표지 렌더링 ======
        function renderCover(project, method) {
            const methodFullName = METHOD_FULL_NAMES[method] || method;
            const methodName = METHOD_NAMES[method] || method;
            const companyName = project.company_name || '-';
            const today = new Date();
            const writeDate = today.getFullYear() + '년 ' + (today.getMonth() + 1) + '월 ' + today.getDate() + '일';
            const baseDate = project.valuation_date || writeDate;

            document.getElementById('coverMethodName').textContent = methodFullName + ' (초안)';
            document.getElementById('coverCompanyName').textContent = companyName;
            document.getElementById('coverBaseDate').textContent = baseDate;
            document.getElementById('coverWriteDate').textContent = writeDate;
            document.getElementById('coverMethod').textContent = methodName;
            document.getElementById('coverReportNo').textContent = 'DRAFT-' + projectId;
        }

        // ====== 섹션 내용 렌더링 ======
        function renderSections(sectionMap) {
            SECTION_KEYS.forEach(key => {
                const el = document.getElementById('content-' + key);
                if (!el) return;

                const section = sectionMap[key];
                if (section && section.content && section.content.trim()) {
                    // 내용이 HTML 태그를 포함하면 innerHTML, 아니면 텍스트로 렌더링
                    const content = section.content.trim();
                    if (content.includes('<') && content.includes('>')) {
                        el.innerHTML = content;
                    } else {
                        el.textContent = content;
                    }
                } else {
                    el.innerHTML = '<div class="section-empty">이 섹션의 내용이 아직 작성되지 않았습니다.</div>';
                }
            });
        }

        // ====== 버튼 설정 ======
        function setupButtons(project) {
            const pid = projectId;

            // 수정 요청 링크
            document.getElementById('btnRevision').href =
                `revision-request.html?projectId=${pid}&method=${method}`;

            // 확인 완료 버튼
            document.getElementById('btnConfirm').addEventListener('click', async () => {
                if (!confirm('평가보고서 초안 확인을 완료하시겠습니까?\n\n확인 후 최종 보고서 작성이 진행됩니다.')) {
                    return;
                }

                const btn = document.getElementById('btnConfirm');
                btn.disabled = true;
                btn.textContent = '처리 중...';

                try {
                    const { error } = await supabase
                        .from('draft_method_status')
                        .upsert({
                            project_id: pid,
                            method: method,
                            draft_status: 'confirmed',
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'project_id,method' });

                    if (error) throw error;

                    alert('초안 확인이 완료되었습니다.\n최종 보고서 작성이 진행됩니다.');
                    showState('confirmedState');
                    document.getElementById('confirmedGoFinal').href = 'report-final.html?projectId=' + encodeURIComponent(projectId) + '&method=' + encodeURIComponent(method);

                } catch (err) {
                    console.error('확인 완료 처리 오류:', err);
                    alert('처리 중 오류가 발생했습니다. 다시 시도해주세요.');
                    btn.disabled = false;
                    btn.textContent = '확인 완료';
                }
            });
        }

        // ====== TOC 스무스 스크롤 ======
        document.querySelectorAll('.toc-item a').forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.querySelector(a.getAttribute('href'));
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

        // ====== 페이지 로드 ======
        initializePage();
    </script>
</body>
</html>
