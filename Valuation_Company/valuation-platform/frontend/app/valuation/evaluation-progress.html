<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‰ê°€ ì§„í–‰ ì¤‘ | ValueLink</title>
    
    <!-- ëª¨ë°”ì¼ ìµœì í™” CSS -->
    <link rel="stylesheet" href="../styles/mobile-optimize.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --deep-blue: #1D4ED8;
            --deep-green: #166534;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --white: #FFFFFF;
            --border: #E5E7EB;
            --success: #10B981;
            --warning: #F59E0B;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #F9FAFB;
            color: var(--text-primary);
        }

        /* Container */
        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            gap: 40px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .page-description {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Project Info Card */
        .project-info-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .project-info-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-id {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--deep-blue);
        }

        /* Evaluation Progress Section */
        .evaluation-section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .evaluation-section h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 32px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .progress-percentage {
            font-size: 24px;
            font-weight: 700;
            color: var(--deep-green);
        }

        .progress-bar-wrapper {
            height: 12px;
            background: #E5E7EB;
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--deep-green), #10B981);
            border-radius: 999px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Evaluation Steps */
        .evaluation-steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .evaluation-step {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: #F9FAFB;
            border: 2px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .evaluation-step.waiting {
            opacity: 0.5;
        }

        .evaluation-step.in-progress {
            border-color: var(--warning);
            background: #FFFBEB;
        }

        .evaluation-step.completed {
            border-color: var(--success);
            background: #ECFDF5;
        }

        .step-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .step-details {
            flex: 1;
        }

        .step-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .step-description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .step-status {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .step-status.waiting {
            color: var(--text-secondary);
        }

        .step-status.in-progress {
            color: var(--warning);
        }

        .step-status.completed {
            color: var(--success);
        }

        /* Estimated Time */
        .time-estimate {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: #DBEAFE;
            border: 2px solid #93C5FD;
            border-radius: 12px;
        }

        .time-icon {
            font-size: 32px;
        }

        .time-info {
            flex: 1;
        }

        .time-label {
            font-size: 14px;
            font-weight: 600;
            color: #1E40AF;
            margin-bottom: 4px;
        }

        .time-value {
            font-size: 20px;
            font-weight: 700;
            color: #1E3A8A;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E5E7EB;
            border-top-color: var(--deep-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ì ‘ê·¼ ê¶Œí•œ í™•ì¸ -->
    <div id="access-denied" style="display:none;">
        <div style="text-align:center; padding:80px 20px; max-width:500px; margin:0 auto;">
            <div style="font-size:48px; margin-bottom:20px;">ğŸ”’</div>
            <h2 style="color:#1F2937; margin-bottom:12px;">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h2>
            <p style="color:#6B7280; margin-bottom:24px;">ì´ í˜ì´ì§€ëŠ” ë‹´ë‹¹ íšŒê³„ì‚¬ ë° ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>í˜„ì¬ ì§„í–‰ ìƒíƒœëŠ” ì‚¬ì´ë“œë°”ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <a href="../valuation.html" style="display:inline-block; padding:12px 24px; background:#166534; color:white; border-radius:8px; text-decoration:none; font-weight:600;">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>

    <script>
        // Supabase ì„¸ì…˜ ê¸°ë°˜ ì—­í•  ì²´í¬
        (function() {
            var role = localStorage.getItem('userRole') || 'customer';
            if (role === 'accountant' || role === 'admin') return;

            document.getElementById('access-denied').style.display = 'block';
            document.addEventListener('DOMContentLoaded', function() {
                var header = document.getElementById('header-container');
                if (header) header.style.display = 'none';
                var container = document.querySelector('.container');
                if (container) container.style.display = 'none';

                var script = document.createElement('script');
                script.type = 'module';
                script.textContent = `
                    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
                    try {
                        const supabase = createClient(
                            'https://arxrfetgaitkgiiqabap.supabase.co',
                            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeHJmZXRnYWl0a2dpaXFhYmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1OTgsImV4cCI6MjA4NDM2NTU5OH0.BTnuv0sYr2MGe1c-gk8PWCviwkFyIiymfKp5Jhzwbo0'
                        );
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session && session.user) {
                            const email = session.user.email.toLowerCase();
                            const { data: userData } = await supabase
                                .from('users').select('role').eq('user_id', session.user.id).single();
                            const detectedRole = (userData && userData.role) ? userData.role
                                : (['wksun999@gmail.com'].includes(email) ? 'admin' : 'customer');
                            if (detectedRole === 'admin' || detectedRole === 'accountant') {
                                localStorage.setItem('userRole', detectedRole);
                                localStorage.setItem('userEmail', email);
                                location.reload();
                            }
                        }
                    } catch(e) { console.warn('Supabase ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', e); }
                `;
                document.body.appendChild(script);
            });
        })();
    </script>

    <!-- í—¤ë” -->
    <div id="header-container"></div>

    <div class="container">
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">í‰ê°€ ì§„í–‰ ì¤‘</h1>
                <p class="page-description">í‰ê°€ ì—”ì§„ì´ ê¸°ì—…ê°€ì¹˜ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <!-- ë¡œë”© ìƒíƒœ -->
            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                <p class="loading-text">í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <!-- í”„ë¡œì íŠ¸ ì •ë³´ -->
            <div id="projectInfoCard" class="project-info-card" style="display: none;">
                <h3>í”„ë¡œì íŠ¸ ì •ë³´</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">í”„ë¡œì íŠ¸ ë²ˆí˜¸</span>
                        <span class="info-value project-id" id="projectIdDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">íšŒì‚¬ëª…</span>
                        <span class="info-value" id="companyNameDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">í‰ê°€ë²•</span>
                        <span class="info-value" id="methodDisplay">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">í‰ê°€ ê¸°ì¤€ì¼</span>
                        <span class="info-value" id="valuationDateDisplay">-</span>
                    </div>
                </div>
            </div>

            <!-- í‰ê°€ ì§„í–‰ ìƒí™© -->
            <div id="evaluationSection" class="evaluation-section" style="display: none;">
                <h3>í‰ê°€ ì§„í–‰ ìƒí™©</h3>

                <!-- ì§„í–‰ë¥  ë°” -->
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-label">ì „ì²´ ì§„í–‰ë¥ </span>
                        <span class="progress-percentage" id="progressPercentage">0%</span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- í‰ê°€ ë‹¨ê³„ -->
                <div class="evaluation-steps" id="evaluationSteps">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>

                <!-- ì˜ˆìƒ ì†Œìš” ì‹œê°„ -->
                <div class="time-estimate" id="timeEstimate">
                    <span class="time-icon">â±ï¸</span>
                    <div class="time-info">
                        <div class="time-label">ì˜ˆìƒ ë‚¨ì€ ì‹œê°„</div>
                        <div class="time-value" id="timeRemaining">ê³„ì‚° ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div id="emptyState" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 16px;">ğŸ“Š</div>
                <p style="font-size: 16px; color: #6B7280; margin-bottom: 12px;">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="color: #9CA3AF; font-size: 14px;">í”„ë¡œì íŠ¸ê°€ ì´ ë‹¨ê³„ì— ë„ë‹¬í•˜ë©´ ìë™ìœ¼ë¡œ í‰ê°€ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</p>
            </div>
        </main>

    </div>

    <!-- í—¤ë” ë¡œë“œ -->
    <script>
        fetch('../../components/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
                const scripts = document.getElementById('header-container').querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });
            })
            .catch(error => console.error('í—¤ë” ë¡œë“œ ì‹¤íŒ¨:', error));
    </script>

    <!-- í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        import { checkMethodStatus, METHOD_NAMES, STATUS } from '../../components/project-status-checker.js';

        // Supabase í´ë¼ì´ì–¸íŠ¸
        const SUPABASE_URL = 'https://arxrfetgaitkgiiqabap.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeHJmZXRnYWl0a2dpaXFhYmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1OTgsImV4cCI6MjA4NDM2NTU5OH0.BTnuv0sYr2MGe1c-gk8PWCviwkFyIiymfKp5Jhzwbo0';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // í‰ê°€ ë‹¨ê³„ ì •ì˜ (í‰ê°€ë²•ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
        const EVALUATION_STEPS = {
            dcf: [
                { id: 1, name: 'ì¬ë¬´ì œí‘œ ë¶„ì„', description: 'ê³¼ê±° ì¬ë¬´ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 2, name: 'í˜„ê¸ˆíë¦„ ì¶”ì •', description: 'ë¯¸ë˜ í˜„ê¸ˆíë¦„ì„ ì˜ˆì¸¡í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 3, name: 'í• ì¸ìœ¨ ê³„ì‚°', description: 'WACC(ê°€ì¤‘í‰ê· ìë³¸ë¹„ìš©)ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 4, name: 'í„°ë¯¸ë„ ë°¸ë¥˜ ê³„ì‚°', description: 'ì˜êµ¬ì„±ì¥ê°€ì¹˜ë¥¼ ì‚°ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 5, name: 'ê¸°ì—…ê°€ì¹˜ ì‚°ì¶œ', description: 'í˜„ì¬ê°€ì¹˜ë¡œ í• ì¸í•˜ì—¬ ê¸°ì—…ê°€ì¹˜ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤' }
            ],
            relative: [
                { id: 1, name: 'ë¹„êµê¸°ì—… ì„ ì •', description: 'ìœ ì‚¬ ìƒì¥ê¸°ì—…ì„ ì„ ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 2, name: 'ì¬ë¬´ì§€í‘œ ìˆ˜ì§‘', description: 'ë¹„êµê¸°ì—…ì˜ ì¬ë¬´ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 3, name: 'ë°°ìˆ˜ ê³„ì‚°', description: 'PER, PBR, EV/EBITDA ë“±ì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 4, name: 'ì¡°ì • ë° ë³´ì •', description: 'ì°¨ì´ì ì„ ë°˜ì˜í•˜ì—¬ ë°°ìˆ˜ë¥¼ ì¡°ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 5, name: 'ê¸°ì—…ê°€ì¹˜ ì‚°ì¶œ', description: 'ì¡°ì •ëœ ë°°ìˆ˜ë¡œ ê¸°ì—…ê°€ì¹˜ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤' }
            ],
            intrinsic: [
                { id: 1, name: 'ìˆ˜ìµë ¥ ë¶„ì„', description: 'ê³¼ê±° ìˆ˜ìµì„±ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 2, name: 'ì •ìƒìˆ˜ìµ ì¶”ì •', description: 'ì§€ì†ê°€ëŠ¥í•œ ì •ìƒìˆ˜ìµì„ ì¶”ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 3, name: 'ìë³¸í™˜ì›ìœ¨ ê²°ì •', description: 'ì ì • ìë³¸í™˜ì›ìœ¨ì„ ì‚°ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 4, name: 'ì˜ì—…ê¶Œ ê°€ì¹˜ ê³„ì‚°', description: 'ì´ˆê³¼ìˆ˜ìµë ¥ì„ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 5, name: 'ê¸°ì—…ê°€ì¹˜ ì‚°ì¶œ', description: 'ìˆœìì‚°ê°€ì¹˜ì— ì˜ì—…ê¶Œì„ ë”í•˜ê³  ìˆìŠµë‹ˆë‹¤' }
            ],
            asset: [
                { id: 1, name: 'ìì‚° ëª©ë¡ ì‘ì„±', description: 'ëª¨ë“  ìì‚°ì„ ì‹ë³„í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 2, name: 'ì‹œê°€ í‰ê°€', description: 'ê° ìì‚°ì˜ ê³µì •ê°€ì¹˜ë¥¼ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 3, name: 'ë¶€ì±„ í‰ê°€', description: 'ë¶€ì±„ì˜ ì‹œê°€ë¥¼ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 4, name: 'ìˆœìì‚° ê³„ì‚°', description: 'ìì‚°ì—ì„œ ë¶€ì±„ë¥¼ ì°¨ê°í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 5, name: 'ê¸°ì—…ê°€ì¹˜ ì‚°ì¶œ', description: 'ìµœì¢… ìˆœìì‚°ê°€ì¹˜ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤' }
            ],
            inheritance_tax: [
                { id: 1, name: 'ìˆœìì‚°ê°€ì•¡ ê³„ì‚°', description: 'ìì‚°ê³¼ ë¶€ì±„ë¥¼ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 2, name: 'ìˆ˜ìµê°€ì•¡ ê³„ì‚°', description: 'ìµœê·¼ 3ë…„ í‰ê· ì´ìµì„ ì‚°ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 3, name: 'ê°€ì¤‘í‰ê·  ê³„ì‚°', description: 'ìˆœìì‚°ê°€ì•¡ê³¼ ìˆ˜ìµê°€ì•¡ì„ ê°€ì¤‘í‰ê· í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 4, name: 'í• ì¦/í• ì¸ ì ìš©', description: 'ì§€ë°°ì£¼ì£¼ í• ì¦ ë“±ì„ ë°˜ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤' },
                { id: 5, name: 'ê¸°ì—…ê°€ì¹˜ ì‚°ì¶œ', description: 'ìµœì¢… í‰ê°€ì•¡ì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤' }
            ]
        };

        let progressInterval = null;
        let currentProgress = 0;

        async function loadProject() {
            try {
                // URLì—ì„œ projectIdì™€ method ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                const method = urlParams.get('method');

                if (!projectId || !method) {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // í”„ë¡œì íŠ¸ ì •ë³´ ì¡°íšŒ
                const { data: project, error } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('project_id', projectId)
                    .single();

                if (error || !project) {
                    console.error('í”„ë¡œì íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // í‰ê°€ë²• ìƒíƒœ í™•ì¸
                const methodStatus = await checkMethodStatus(projectId, method);

                // í”„ë¡œì íŠ¸ ì •ë³´ í‘œì‹œ
                displayProjectInfo(project, method);

                // í‰ê°€ ì§„í–‰ ìƒí™© í‘œì‹œ
                displayEvaluationProgress(method);

                // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                startProgressSimulation();

                // ë¡œë”© ìˆ¨ê¹€
                document.getElementById('loadingState').style.display = 'none';

            } catch (error) {
                console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function displayProjectInfo(project, method) {
            const methodName = METHOD_NAMES[method] || method;

            document.getElementById('projectIdDisplay').textContent = project.project_id;
            document.getElementById('companyNameDisplay').textContent =
                project.company_name || '-';
            document.getElementById('methodDisplay').textContent = methodName;
            document.getElementById('valuationDateDisplay').textContent =
                project.valuation_date || '-';

            document.getElementById('projectInfoCard').style.display = 'block';
        }

        function displayEvaluationProgress(method) {
            const steps = EVALUATION_STEPS[method] || EVALUATION_STEPS.dcf;
            const stepsContainer = document.getElementById('evaluationSteps');
            stepsContainer.innerHTML = '';

            steps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'evaluation-step waiting';
                stepElement.id = `step-${step.id}`;

                stepElement.innerHTML = `
                    <span class="step-icon">â³</span>
                    <div class="step-details">
                        <div class="step-name">${step.name}</div>
                        <div class="step-description">${step.description}</div>
                    </div>
                    <div class="step-status waiting">
                        ëŒ€ê¸° ì¤‘
                    </div>
                `;

                stepsContainer.appendChild(stepElement);
            });

            document.getElementById('evaluationSection').style.display = 'block';
        }

        async function pollEvaluationProgress() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                const method = urlParams.get('method');

                // Backend API í˜¸ì¶œ
                const response = await fetch(
                    `http://localhost:8000/api/v1/valuation/progress?project_id=${projectId}&method=${method}`
                );

                if (!response.ok) {
                    console.error('Progress API error:', response.status);
                    return;
                }

                const data = await response.json();

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                const progressPercent = data.progress || 0;
                updateProgressBar(progressPercent);

                // í‰ê°€ ë‹¨ê³„ ì—…ë°ì´íŠ¸ (progress 10-30%ë¥¼ 5ê°œ ë‹¨ê³„ì— ë§¤í•‘)
                // Step 0-4: ì§„í–‰ë¥  10-30% êµ¬ê°„
                const stepIndex = Math.max(0, Math.min(4, Math.floor((progressPercent - 10) / 4)));
                updateEvaluationSteps(stepIndex, method);

                // ì˜ˆìƒ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
                const remainingPercent = 100 - progressPercent;
                const estimatedMinutes = Math.ceil(remainingPercent / 5); // ~5% per minute
                updateRemainingTime(estimatedMinutes);

                // Step 12 ì™„ë£Œ ì‹œ ì”ê¸ˆ ì…ê¸ˆ í˜ì´ì§€ë¡œ ì´ë™
                if (data.current_step === 12) {
                    clearInterval(progressInterval);

                    // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ í‘œì‹œ
                    const steps = EVALUATION_STEPS[method] || EVALUATION_STEPS.dcf;
                    steps.forEach((step) => {
                        const stepElement = document.getElementById(`step-${step.id}`);
                        if (stepElement) {
                            stepElement.className = 'evaluation-step completed';
                            stepElement.querySelector('.step-icon').textContent = 'âœ…';
                            stepElement.querySelector('.step-status').className = 'step-status completed';
                            stepElement.querySelector('.step-status').textContent = 'ì™„ë£Œ';
                        }
                    });

                    updateProgressBar(100);
                    document.getElementById('timeRemaining').textContent = 'ì™„ë£Œ';

                    // 3ì´ˆ í›„ ì”ê¸ˆ ì…ê¸ˆ í˜ì´ì§€ë¡œ ì´ë™ (Step 13)
                    setTimeout(() => {
                        window.location.href = `./balance-payment.html?projectId=${projectId}&method=${method}`;
                    }, 3000);
                }
                // Step 7-11: íšŒê³„ì‚¬ ê²€í†  ë° ë³´ê³ ì„œ ì‘ì„± ì§„í–‰ ì¤‘
                else if (data.current_step >= 7 && data.current_step < 12) {
                    // íšŒê³„ì‚¬ ê²€í†  ë‹¨ê³„ í‘œì‹œ (UI ì—…ë°ì´íŠ¸ë§Œ)
                    const currentStepInfo = EVALUATION_STEPS[method] || EVALUATION_STEPS.dcf;
                    console.log(`Step ${data.current_step}: íšŒê³„ì‚¬ ê²€í†  ì§„í–‰ ì¤‘...`);
                }
            } catch (error) {
                console.error('Evaluation progress polling error:', error);
            }
        }

        function updateEvaluationSteps(currentStepIndex, method) {
            const steps = EVALUATION_STEPS[method] || EVALUATION_STEPS.dcf;

            steps.forEach((step, index) => {
                const stepElement = document.getElementById(`step-${step.id}`);
                if (!stepElement) return;

                if (index < currentStepIndex) {
                    // ì™„ë£Œëœ ë‹¨ê³„
                    stepElement.className = 'evaluation-step completed';
                    stepElement.querySelector('.step-icon').textContent = 'âœ…';
                    stepElement.querySelector('.step-status').className = 'step-status completed';
                    stepElement.querySelector('.step-status').textContent = 'ì™„ë£Œ';
                } else if (index === currentStepIndex) {
                    // ì§„í–‰ ì¤‘ì¸ ë‹¨ê³„
                    stepElement.className = 'evaluation-step in-progress';
                    stepElement.querySelector('.step-icon').textContent = 'âš™ï¸';
                    stepElement.querySelector('.step-status').className = 'step-status in-progress';
                    stepElement.querySelector('.step-status').textContent = 'ì§„í–‰ ì¤‘...';
                } else {
                    // ëŒ€ê¸° ì¤‘ì¸ ë‹¨ê³„
                    stepElement.className = 'evaluation-step waiting';
                    stepElement.querySelector('.step-icon').textContent = 'â³';
                    stepElement.querySelector('.step-status').className = 'step-status waiting';
                    stepElement.querySelector('.step-status').textContent = 'ëŒ€ê¸° ì¤‘';
                }
            });
        }

        function updateRemainingTime(minutes) {
            const timeElement = document.getElementById('timeRemaining');
            if (minutes <= 0) {
                timeElement.textContent = 'ê³§ ì™„ë£Œë©ë‹ˆë‹¤';
            } else if (minutes === 1) {
                timeElement.textContent = 'ì•½ 1ë¶„';
            } else {
                timeElement.textContent = `ì•½ ${minutes}ë¶„`;
            }
        }

        function startProgressSimulation() {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ 1ë²ˆë§Œ í˜¸ì¶œ (Polling ì œê±°)
            // 24-48ì‹œê°„ ì†Œìš” ì‘ì—…ì´ë¯€ë¡œ ì‹¤ì‹œê°„ polling ë¶ˆí•„ìš”
            // ì´ë©”ì¼ ì•Œë¦¼ìœ¼ë¡œ ë‹¨ê³„ ì™„ë£Œ í†µì§€
            pollEvaluationProgress();

            // âŒ 3ì´ˆ polling ì œê±° (24ì‹œê°„ ì‘ì—…ì— 28,800ë²ˆ ìš”ì²­ì€ ê³¼ë„í•¨)
            // progressInterval = setInterval(pollEvaluationProgress, 3000);
        }

        function updateProgressBar(percentage) {
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        loadProject();
    </script>
</body>
</html>
