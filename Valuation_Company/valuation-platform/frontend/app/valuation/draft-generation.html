<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‰ê°€ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„± | ValueLink</title>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- ëª¨ë°”ì¼ ìµœì í™” CSS -->
    <link rel="stylesheet" href="../styles/mobile-optimize.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --deep-green: #166534;
            --deep-blue: #1D4ED8;
            --amber: #F59E0B;
            --deep-blue-light: #3B82F6;
            --deep-blue-pale: #DBEAFE;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-muted: #6B7280;
            --bg-light: #F3F4F6;
            --white: #FFFFFF;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --border: #E5E7EB;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* HERO SECTION */
        .hero-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 48px 40px; color: white; text-align: center; }
        .hero-content { max-width: 1200px; margin: 0 auto; }
        .hero-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .hero-subtitle { font-size: 16px; opacity: 0.9; margin-bottom: 16px; }
        .hero-badge { display: inline-block; background: rgba(255, 255, 255, 0.2); padding: 6px 14px; border-radius: 20px; font-size: 13px; }

        /* Main Layout - 2 columns */
        .page-wrapper {
            display: flex;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 40px;
        }

        .editor-area { flex: 7; min-width: 0; }
        .side-panel { flex: 3; min-width: 280px; max-width: 360px; }

        /* Tabs */
        .tab-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            background: var(--white);
            border-radius: 12px 12px 0 0;
            padding: 12px 16px 0;
            border: 1px solid var(--border);
            border-bottom: none;
        }

        .tab-btn {
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover { background: var(--bg-light); color: var(--text-secondary); }
        .tab-btn.active { color: var(--deep-blue); border-bottom-color: var(--deep-blue); background: var(--deep-blue-pale); }
        .tab-btn.completed { color: var(--success); }
        .tab-btn.completed::before { content: ''; display: inline-block; width: 6px; height: 6px; background: var(--success); border-radius: 50%; margin-right: 6px; vertical-align: middle; }

        /* Editor Panel */
        .editor-panel {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 0 0 12px 12px;
            padding: 32px;
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-title-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .section-hint {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
            padding: 12px 16px;
            background: #F0F9FF;
            border-left: 3px solid var(--deep-blue-light);
            border-radius: 0 8px 8px 0;
        }

        .editor-textarea {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-primary);
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
            margin-top: 16px;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: var(--deep-blue-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .completion-check {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .completion-check input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--success);
            cursor: pointer;
        }

        .save-status {
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .save-status.saving { color: var(--amber); }
        .save-status.saved { color: var(--success); }
        .save-status.error { color: var(--error); }

        .char-count {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Side Panel */
        .side-card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 20px;
        }

        .side-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Project Info */
        .project-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid #F3F4F6;
        }

        .project-info-row:last-child { border-bottom: none; }
        .project-info-label { color: var(--text-muted); }
        .project-info-value { font-weight: 600; color: var(--text-primary); }

        /* Progress */
        .progress-bar-wrapper {
            width: 100%;
            height: 10px;
            background: var(--bg-light);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--deep-blue), var(--success));
            border-radius: 5px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--deep-blue);
            text-align: center;
            margin-bottom: 16px;
        }

        /* Section Checklist */
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background 0.2s;
        }

        .checklist-item:hover { background: var(--bg-light); }
        .checklist-item.active { background: var(--deep-blue-pale); color: var(--deep-blue); font-weight: 600; }
        .checklist-item.completed { color: var(--success); }

        .checklist-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            flex-shrink: 0;
        }

        .checklist-item.completed .checklist-icon {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .checklist-item.active .checklist-icon {
            border-color: var(--deep-blue);
        }

        /* Submit Button */
        .btn-submit-draft {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--deep-blue) 0%, #7C3AED 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-submit-draft:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(29,78,216,0.3); }
        .btn-submit-draft:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .submit-note {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 8px;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 80px 20px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--deep-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        footer {
            background: #1E3A5F;
            color: var(--white);
            padding: 32px 40px;
            margin-top: 60px;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-logo { font-size: 18px; font-weight: 700; }
        .footer-text { font-size: 13px; opacity: 0.7; }

        /* Responsive */
        @media (max-width: 1024px) {
            .page-wrapper { flex-direction: column; }
            .side-panel { max-width: none; }
        }

        @media (max-width: 768px) {
            .page-wrapper { padding: 20px; }
            .hero-title { font-size: 24px; }
            .editor-panel { padding: 20px; }
            .editor-textarea { min-height: 300px; }
            .tab-btn { font-size: 12px; padding: 6px 10px; }
        }
    </style>
</head>
<body>
    <!-- ì ‘ê·¼ ê¶Œí•œ í™•ì¸ -->
    <div id="access-denied" style="display:none;">
        <div style="text-align:center; padding:80px 20px; max-width:500px; margin:0 auto;">
            <div style="font-size:48px; margin-bottom:20px;">ğŸ”’</div>
            <h2 style="color:#1F2937; margin-bottom:12px;">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h2>
            <p style="color:#6B7280; margin-bottom:24px;">ì´ í˜ì´ì§€ëŠ” ë‹´ë‹¹ íšŒê³„ì‚¬ ë° ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>í˜„ì¬ ì§„í–‰ ìƒíƒœëŠ” ì‚¬ì´ë“œë°”ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <a href="../valuation.html" style="display:inline-block; padding:12px 24px; background:#166534; color:white; border-radius:8px; text-decoration:none; font-weight:600;">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>

    <script>
        (function() {
            var role = localStorage.getItem('userRole') || 'customer';
            if (role === 'accountant' || role === 'admin') return;
            document.getElementById('access-denied').style.display = 'block';
            document.addEventListener('DOMContentLoaded', function() {
                var els = ['header-container', '.hero-section', '.page-wrapper', 'footer'];
                ['header-container'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                ['.hero-section', '.page-wrapper', 'footer'].forEach(function(sel) {
                    var el = document.querySelector(sel);
                    if (el) el.style.display = 'none';
                });
            });
        })();
    </script>

    <!-- Header -->
    <div id="header-container"></div>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">í‰ê°€ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„±</h1>
            <p class="hero-subtitle">9ê°œ ì„¹ì…˜ì„ ì‘ì„±í•˜ì—¬ í‰ê°€ë³´ê³ ì„œ ì´ˆì•ˆì„ ì™„ì„±í•©ë‹ˆë‹¤</p>
            <div class="hero-badge">
                <span>í”„ë¡œì íŠ¸ ID: </span>
                <span id="hero-project-id">-</span>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
        <div class="loading-spinner"></div>
        <p style="color: var(--text-muted);">í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- Main Content -->
    <div class="page-wrapper" id="mainContent" style="display:none;">
        <!-- Editor Area (70%) -->
        <main class="editor-area">
            <!-- Tab Bar -->
            <div class="tab-bar" id="tabBar">
                <!-- Tabs will be dynamically generated -->
            </div>

            <!-- Editor Panel -->
            <div class="editor-panel">
                <div class="section-header">
                    <div class="section-title-text" id="sectionTitle">-</div>
                    <div class="section-hint" id="sectionHint">-</div>
                </div>

                <textarea class="editor-textarea" id="editorTextarea" placeholder="ì´ ì„¹ì…˜ì˜ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>

                <div class="editor-footer">
                    <label class="completion-check">
                        <input type="checkbox" id="completionCheck">
                        ì´ ì„¹ì…˜ ì‘ì„± ì™„ë£Œ
                    </label>
                    <div>
                        <span class="char-count" id="charCount">0ì</span>
                        <span class="save-status" id="saveStatus"></span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Side Panel (30%) -->
        <aside class="side-panel">
            <!-- Project Info -->
            <div class="side-card">
                <div class="side-card-title">ğŸ“‹ í”„ë¡œì íŠ¸ ì •ë³´</div>
                <div class="project-info-row">
                    <span class="project-info-label">ê¸°ì—…ëª…</span>
                    <span class="project-info-value" id="infoCompany">-</span>
                </div>
                <div class="project-info-row">
                    <span class="project-info-label">í”„ë¡œì íŠ¸ ID</span>
                    <span class="project-info-value" id="infoProjectId" style="font-family:monospace; font-size:12px;">-</span>
                </div>
                <div class="project-info-row">
                    <span class="project-info-label">í‰ê°€ ë°©ë²•</span>
                    <span class="project-info-value" id="infoMethod">-</span>
                </div>
                <div class="project-info-row">
                    <span class="project-info-label">í‰ê°€ ê¸°ì¤€ì¼</span>
                    <span class="project-info-value" id="infoBaseDate">-</span>
                </div>
                <div class="project-info-row">
                    <span class="project-info-label">ë‹´ë‹¹ íšŒê³„ì‚¬</span>
                    <span class="project-info-value" id="infoAccountant">-</span>
                </div>
            </div>

            <!-- Progress -->
            <div class="side-card">
                <div class="side-card-title">ğŸ“Š ì‘ì„± ì§„í–‰ë¥ </div>
                <div class="progress-text" id="progressText">0 / 9 ì„¹ì…˜ ì™„ë£Œ</div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="progressBar" style="width:0%"></div>
                </div>

                <div id="checklist">
                    <!-- Checklist items will be generated -->
                </div>
            </div>

            <!-- Submit -->
            <div class="side-card">
                <button class="btn-submit-draft" id="btnSubmitDraft" disabled onclick="submitDraft()">
                    ì´ˆì•ˆ ì œì¶œ
                </button>
                <div class="submit-note">9ê°œ ì„¹ì…˜ ëª¨ë‘ ì™„ë£Œ ì‹œ í™œì„±í™”ë©ë‹ˆë‹¤</div>
            </div>
        </aside>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">ValueLink</div>
            <div class="footer-text">&copy; 2026 ValueLink. All rights reserved.</div>
        </div>
    </footer>

    <!-- Header Load Script -->
    <script>
        fetch('../../components/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
                const scripts = document.getElementById('header-container').querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) { newScript.src = script.src; }
                    else { newScript.textContent = script.textContent; }
                    document.body.appendChild(newScript);
                });
            })
            .catch(error => console.error('í—¤ë” ë¡œë“œ ì‹¤íŒ¨:', error));
    </script>

    <!-- Main Script -->
    <script>
        // ====== Supabase ì´ˆê¸°í™” ======
        const SUPABASE_URL = 'https://arxrfetgaitkgiiqabap.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeHJmZXRnYWl0a2dpaXFhYmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNzIxNDMsImV4cCI6MjA2Mjk0ODE0M30.aGSJFVFW5P_E9l4sBz5_7MWJiN5YOhMJXBbLPi7bo0';
        let supabaseClient = null;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) {
            console.warn('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        }

        // ====== 9ê°œ ì„¹ì…˜ ì •ì˜ ======
        const SECTIONS = [
            { key: 'summary', title: 'I. ìš”ì•½ (Executive Summary)', hint: 'í‰ê°€ ê²°ê³¼ì˜ í•µì‹¬ ìš”ì•½ì„ ì‘ì„±í•©ë‹ˆë‹¤. í‰ê°€ ë°©ë²•, ì£¼ë‹¹ í‰ê°€ê°€ì¹˜, ê¸°ì—…ê°€ì¹˜ ë“± í•µì‹¬ ê²°ê³¼ë¥¼ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•©ë‹ˆë‹¤.' },
            { key: 'overview', title: 'II. í‰ê°€ ê°œìš”', hint: 'í‰ê°€ ëª©ì , í‰ê°€ ë²”ìœ„, ì ìš©í•œ í‰ê°€ ë°©ë²•ë¡ , í‰ê°€ ê¸°ì¤€ì¼ ë“±ì„ ê¸°ìˆ í•©ë‹ˆë‹¤.' },
            { key: 'company', title: 'III. íšŒì‚¬ ê°œìš” ë° ì‚°ì—… ë¶„ì„', hint: 'ëŒ€ìƒ ê¸°ì—… ì†Œê°œ(ì„¤ë¦½ì¼, ì—…ì¢…, ì£¼ìš” ì‚¬ì—… ë“±)ì™€ í•´ë‹¹ ì‚°ì—…ì˜ ë™í–¥ ë° ì „ë§ì„ ë¶„ì„í•©ë‹ˆë‹¤.' },
            { key: 'financial', title: 'IV. ì¬ë¬´ ë¶„ì„', hint: 'ê³¼ê±° 3ê°œë…„ ì¬ë¬´ì œí‘œ ë¶„ì„, ìˆ˜ìµì„±/ì•ˆì •ì„±/ì„±ì¥ì„± ì§€í‘œ, ì¬ë¬´ ê±´ì „ì„± í‰ê°€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.' },
            { key: 'methodology', title: 'V. í‰ê°€ ë°©ë²•ë¡  ë° ê°€ì •', hint: 'ì ìš©í•œ í‰ê°€ ë°©ë²•ë¡ ì˜ ìƒì„¸ ì„¤ëª…, ì£¼ìš” ê°€ì • ì‚¬í•­(í• ì¸ìœ¨, ì„±ì¥ë¥ , ë°°ìˆ˜ ë“±)ì„ ê¸°ìˆ í•©ë‹ˆë‹¤.' },
            { key: 'results', title: 'VI. í‰ê°€ ê²°ê³¼', hint: 'ì‚°ì¶œëœ ê¸°ì—…ê°€ì¹˜ì™€ ì£¼ë‹¹ í‰ê°€ê°€ì¹˜ë¥¼ ìƒì„¸ ì‚°ì¶œ ê³¼ì •ê³¼ í•¨ê»˜ ì œì‹œí•©ë‹ˆë‹¤.' },
            { key: 'sensitivity', title: 'VII. ë¯¼ê°ë„ ë¶„ì„', hint: 'ì£¼ìš” ë³€ìˆ˜(í• ì¸ìœ¨, ì„±ì¥ë¥  ë“±) ë³€ë™ì— ë”°ë¥¸ ê¸°ì—…ê°€ì¹˜ ë³€í™”ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.' },
            { key: 'conclusion', title: 'VIII. ê²°ë¡ ', hint: 'ìµœì¢… í‰ê°€ ì˜ê²¬, í‰ê°€ ê²°ê³¼ì˜ ì˜ë¯¸, ì œí•œì‚¬í•­ ë° ë©´ì±… ì¡°í•­ì„ ì‘ì„±í•©ë‹ˆë‹¤.' },
            { key: 'appendix', title: 'IX. ë¶€ë¡', hint: 'ì°¸ê³ ìë£Œ, ì¬ë¬´ì œí‘œ ì›ë³¸, ê°€ì • ê·¼ê±° ìë£Œ, ë©´ì±…ì‚¬í•­ ë“±ì„ ì²¨ë¶€í•©ë‹ˆë‹¤.' }
        ];

        const METHOD_NAMES = {
            dcf: 'DCFí‰ê°€ë²•',
            relative: 'ìƒëŒ€ê°€ì¹˜í‰ê°€ë²•',
            intrinsic: 'ë³¸ì§ˆê°€ì¹˜í‰ê°€ë²•',
            asset: 'ìì‚°ê°€ì¹˜í‰ê°€ë²•',
            inheritance_tax: 'ìƒì¦ì„¸ë²•í‰ê°€ë²•'
        };

        // ====== ìƒíƒœ ê´€ë¦¬ ======
        let currentSectionIndex = 0;
        let sectionData = {}; // { key: { content, is_completed } }
        let saveTimer = null;
        let projectId = null;
        let method = null;

        // ====== ì´ˆê¸°í™” ======
        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id') || urlParams.get('projectId');
            method = urlParams.get('method');

            if (!projectId || !method) {
                alert('í”„ë¡œì íŠ¸ IDì™€ í‰ê°€ ë°©ë²•ì´ í•„ìš”í•©ë‹ˆë‹¤. URL íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('hero-project-id').textContent = projectId;

            // í”„ë¡œì íŠ¸ ì •ë³´ ë¡œë“œ
            await loadProjectInfo();

            // ì„¹ì…˜ ë°ì´í„° ë¡œë“œ
            await loadSections();

            // UI êµ¬ì„±
            renderTabs();
            renderChecklist();
            selectSection(0);
            updateProgress();

            // ë¡œë”© ìˆ¨ê¹€
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'flex';
        }

        // ====== í”„ë¡œì íŠ¸ ì •ë³´ ë¡œë“œ ======
        async function loadProjectInfo() {
            try {
                if (!supabaseClient) throw new Error('No Supabase');

                const { data: project, error } = await supabaseClient
                    .from('projects')
                    .select('company_name, project_id, valuation_date, accountant_name')
                    .eq('project_id', projectId)
                    .single();

                if (!error && project) {
                    document.getElementById('infoCompany').textContent = project.company_name || '-';
                    document.getElementById('infoProjectId').textContent = project.project_id;
                    document.getElementById('infoMethod').textContent = METHOD_NAMES[method] || method;
                    document.getElementById('infoBaseDate').textContent = project.valuation_date || '-';
                    document.getElementById('infoAccountant').textContent = project.accountant_name || '-';
                    return;
                }
            } catch(e) {
                console.warn('í”„ë¡œì íŠ¸ DB ì¡°íšŒ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', e);
            }

            // Fallback (DB ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’)
            document.getElementById('infoCompany').textContent = '-';
            document.getElementById('infoProjectId').textContent = projectId;
            document.getElementById('infoMethod').textContent = METHOD_NAMES[method] || method;
            document.getElementById('infoBaseDate').textContent = '-';
            document.getElementById('infoAccountant').textContent = '-';
        }

        // ====== ì„¹ì…˜ ë°ì´í„° ë¡œë“œ ======
        async function loadSections() {
            // ì´ˆê¸°í™”
            SECTIONS.forEach(s => {
                sectionData[s.key] = { content: '', is_completed: false };
            });

            try {
                if (!supabaseClient) return;

                const { data, error } = await supabaseClient
                    .from('report_draft_sections')
                    .select('section_key, content, is_completed')
                    .eq('project_id', projectId)
                    .eq('method', method);

                if (!error && data) {
                    data.forEach(row => {
                        if (sectionData[row.section_key] !== undefined) {
                            sectionData[row.section_key] = {
                                content: row.content || '',
                                is_completed: row.is_completed || false
                            };
                        }
                    });
                }

                // draft_method_statusë¥¼ in_progressë¡œ ì—…ë°ì´íŠ¸
                await supabaseClient
                    .from('draft_method_status')
                    .upsert({
                        project_id: projectId,
                        method: method,
                        draft_status: 'in_progress',
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'project_id,method' });

            } catch(e) {
                console.warn('ì„¹ì…˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        // ====== íƒ­ ë Œë”ë§ ======
        function renderTabs() {
            const tabBar = document.getElementById('tabBar');
            tabBar.innerHTML = SECTIONS.map((s, i) => {
                const completedClass = sectionData[s.key].is_completed ? 'completed' : '';
                const shortTitle = s.title.split('. ')[1] || s.title;
                // ë¡œë§ˆì + ì¶•ì•½ëª…
                const romanNum = s.title.split('.')[0];
                return `<button class="tab-btn ${completedClass}" data-index="${i}" onclick="selectSection(${i})">${romanNum}. ${shortTitle.split(' (')[0].substring(0, 6)}</button>`;
            }).join('');
        }

        // ====== ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ======
        function renderChecklist() {
            const checklist = document.getElementById('checklist');
            checklist.innerHTML = SECTIONS.map((s, i) => {
                const data = sectionData[s.key];
                const completedClass = data.is_completed ? 'completed' : '';
                const shortTitle = s.title.replace(/^[IVX]+\.\s*/, '').split(' (')[0];
                return `<div class="checklist-item ${completedClass}" data-index="${i}" onclick="selectSection(${i})">
                    <div class="checklist-icon">${data.is_completed ? '&#10003;' : ''}</div>
                    <span>${shortTitle}</span>
                </div>`;
            }).join('');
        }

        // ====== ì„¹ì…˜ ì„ íƒ ======
        function selectSection(index) {
            // í˜„ì¬ ë‚´ìš© ì €ì¥ (ë³€ê²½ëœ ê²½ìš°)
            if (currentSectionIndex !== index) {
                saveSectionImmediate(currentSectionIndex);
            }

            currentSectionIndex = index;
            const section = SECTIONS[index];
            const data = sectionData[section.key];

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('sectionTitle').textContent = section.title;
            document.getElementById('sectionHint').textContent = section.hint;
            document.getElementById('editorTextarea').value = data.content;
            document.getElementById('completionCheck').checked = data.is_completed;
            document.getElementById('charCount').textContent = `${data.content.length}ì`;
            document.getElementById('saveStatus').textContent = '';
            document.getElementById('saveStatus').className = 'save-status';

            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ í™œì„±í™”
            document.querySelectorAll('.checklist-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        // ====== ìë™ ì €ì¥ (2ì´ˆ ë””ë°”ìš´ìŠ¤) ======
        document.getElementById('editorTextarea').addEventListener('input', function() {
            const section = SECTIONS[currentSectionIndex];
            sectionData[section.key].content = this.value;

            // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('charCount').textContent = `${this.value.length}ì`;

            // ì €ì¥ ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = 'ì €ì¥ ëŒ€ê¸° ì¤‘...';
            statusEl.className = 'save-status saving';

            // ë””ë°”ìš´ìŠ¤
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveSectionToDb(section.key);
            }, 2000);
        });

        // ====== ì™„ë£Œ ì²´í¬ë°•ìŠ¤ ======
        document.getElementById('completionCheck').addEventListener('change', function() {
            const section = SECTIONS[currentSectionIndex];
            sectionData[section.key].is_completed = this.checked;

            // ì¦‰ì‹œ ì €ì¥
            saveSectionToDb(section.key);

            // UI ì—…ë°ì´íŠ¸
            renderTabs();
            renderChecklist();
            updateProgress();

            // íƒ­/ì²´í¬ë¦¬ìŠ¤íŠ¸ í™œì„± ìƒíƒœ ë³µì›
            document.querySelectorAll('.tab-btn')[currentSectionIndex].classList.add('active');
            document.querySelectorAll('.checklist-item')[currentSectionIndex].classList.add('active');
        });

        // ====== DB ì €ì¥ ======
        async function saveSectionToDb(sectionKey) {
            const statusEl = document.getElementById('saveStatus');

            try {
                if (!supabaseClient) {
                    statusEl.textContent = 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
                    statusEl.className = 'save-status';
                    return;
                }

                const data = sectionData[sectionKey];
                const sectionDef = SECTIONS.find(s => s.key === sectionKey);
                const userEmail = localStorage.getItem('userEmail') || 'accountant';

                const { error } = await supabaseClient
                    .from('report_draft_sections')
                    .upsert({
                        project_id: projectId,
                        method: method,
                        section_key: sectionKey,
                        section_title: sectionDef.title,
                        content: data.content,
                        is_completed: data.is_completed,
                        updated_by: userEmail,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'project_id,method,section_key' });

                if (error) throw error;

                statusEl.textContent = 'ì €ì¥ ì™„ë£Œ';
                statusEl.className = 'save-status saved';

            } catch(e) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', e);
                statusEl.textContent = 'ì €ì¥ ì‹¤íŒ¨';
                statusEl.className = 'save-status error';
            }
        }

        function saveSectionImmediate(index) {
            const section = SECTIONS[index];
            if (section) {
                clearTimeout(saveTimer);
                saveSectionToDb(section.key);
            }
        }

        // ====== ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ======
        function updateProgress() {
            const completed = SECTIONS.filter(s => sectionData[s.key].is_completed).length;
            const total = SECTIONS.length;
            const pct = Math.round((completed / total) * 100);

            document.getElementById('progressText').textContent = `${completed} / ${total} ì„¹ì…˜ ì™„ë£Œ`;
            document.getElementById('progressBar').style.width = `${pct}%`;

            // ì œì¶œ ë²„íŠ¼ í™œì„±í™”
            const btn = document.getElementById('btnSubmitDraft');
            btn.disabled = (completed < total);
            if (completed >= total) {
                document.querySelector('.submit-note').textContent = 'ëª¨ë“  ì„¹ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ˆì•ˆì„ ì œì¶œí•˜ì„¸ìš”.';
            }
        }

        // ====== ì´ˆì•ˆ ì œì¶œ ======
        async function submitDraft() {
            const completed = SECTIONS.filter(s => sectionData[s.key].is_completed).length;
            if (completed < SECTIONS.length) {
                alert('ëª¨ë“  ì„¹ì…˜ì„ ì™„ë£Œí•´ì•¼ ì´ˆì•ˆì„ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('í‰ê°€ë³´ê³ ì„œ ì´ˆì•ˆì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì œì¶œ í›„ ê³ ê°ì´ ì´ˆì•ˆì„ ê²€í† í•˜ê²Œ ë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                // ë§ˆì§€ë§‰ ì„¹ì…˜ ì €ì¥
                saveSectionImmediate(currentSectionIndex);

                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('draft_method_status')
                        .upsert({
                            project_id: projectId,
                            method: method,
                            draft_status: 'submitted',
                            draft_submitted_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'project_id,method' });

                    if (error) throw error;
                }

                alert('ì´ˆì•ˆì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.\nê³ ê°ì—ê²Œ ê²€í†  ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.');

                // ì´ˆì•ˆ í™•ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = `report-draft.html?projectId=${projectId}&method=${method}`;

            } catch(e) {
                console.error('ì´ˆì•ˆ ì œì¶œ ì‹¤íŒ¨:', e);
                alert('ì´ˆì•ˆ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ====== í˜ì´ì§€ ë¡œë“œ ======
        initializePage();
    </script>
</body>
</html>
