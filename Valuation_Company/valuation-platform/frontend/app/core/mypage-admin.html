<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ValueLink</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- ëª¨ë°”ì¼ ìµœì í™” CSS -->
    <link rel="stylesheet" href="../styles/mobile-optimize.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #F9FAFB;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 16px;
            color: #6B7280;
        }

        .role-badge {
            display: inline-block;
            padding: 6px 16px;
            background: #FEE2E2;
            color: #DC2626;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 12px;
        }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tab-nav {
            display: flex;
            gap: 4px;
            background: white;
            border-radius: 16px;
            padding: 6px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background: transparent;
            color: #6B7280;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            background: #F3F4F6;
            color: #111827;
        }

        .tab-btn.active {
            background: #DC2626;
            color: white;
        }

        .tab-btn .tab-badge {
            display: inline-block;
            min-width: 20px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 6px;
            background: rgba(0,0,0,0.1);
            color: inherit;
        }

        .tab-btn.active .tab-badge {
            background: rgba(255,255,255,0.3);
        }

        /* íƒ­ íŒ¨ë„ */
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stats-grid-7 {
            grid-template-columns: repeat(4, 1fr);
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card.alert {
            border-left: 4px solid #F59E0B;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-icon {
            font-size: 32px;
        }

        .stat-label {
            font-size: 14px;
            color: #6B7280;
            font-weight: 600;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #111827;
        }

        .stat-subtext {
            font-size: 13px;
            color: #6B7280;
            margin-top: 8px;
        }

        /* ì„¹ì…˜ */
        .section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #E5E7EB;
        }

        /* í•„í„° ë°” */
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-select, .filter-input {
            padding: 8px 14px;
            font-size: 14px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            background: white;
            color: #111827;
            font-family: inherit;
        }

        .filter-input {
            min-width: 200px;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #DC2626;
        }

        /* í…Œì´ë¸” */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #F9FAFB;
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #6B7280;
            border-bottom: 2px solid #E5E7EB;
        }

        .data-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #F3F4F6;
            font-size: 14px;
            color: #111827;
        }

        .data-table tr:hover {
            background: #F9FAFB;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #FEF3C7;
            color: #D97706;
        }

        .status-progress {
            background: #DBEAFE;
            color: #1D4ED8;
        }

        .status-completed {
            background: #DCFCE7;
            color: #059669;
        }

        .status-confirmed {
            background: #DCFCE7;
            color: #059669;
        }

        .status-rejected {
            background: #FEE2E2;
            color: #DC2626;
        }

        .status-processing {
            background: #DBEAFE;
            color: #1D4ED8;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn-primary {
            color: white;
            background: #DC2626;
        }

        .btn-primary:hover {
            background: #B91C1C;
        }

        .btn-secondary {
            color: #374151;
            background: #F3F4F6;
        }

        .btn-secondary:hover {
            background: #E5E7EB;
        }

        .btn-success {
            color: white;
            background: #059669;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ë§í¬ */
        .link {
            color: #DC2626;
            text-decoration: none;
            font-weight: 600;
        }

        .link:hover {
            text-decoration: underline;
        }

        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 640px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #F3F4F6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* í¼ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            font-size: 14px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #DC2626;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 14px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            font-family: inherit;
        }

        .page-btn:hover {
            background: #F3F4F6;
        }

        .page-btn.active {
            background: #DC2626;
            color: white;
            border-color: #DC2626;
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6B7280;
        }

        /* ì •ë³´ ê·¸ë¦¬ë“œ */
        .info-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
            font-size: 14px;
        }

        .info-grid dt {
            font-weight: 600;
            color: #6B7280;
        }

        .info-grid dd {
            color: #111827;
        }

        /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ (ê°€ë¡œ ìŠ¤í¬ë¡¤) */
        .table-container {
            overflow-x: auto;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #F3F4F6;
            border-top-color: #DC2626;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast ì•Œë¦¼ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .toast.success { border-left: 4px solid #059669; }
        .toast.error { border-left: 4px solid #DC2626; }
        .toast.info { border-left: 4px solid #1D4ED8; }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            to { transform: translateX(400px); opacity: 0; }
        }

        /* Export ë²„íŠ¼ */
        .export-btn {
            margin-left: auto;
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 28px;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }

            .tab-nav {
                padding: 4px;
            }

            .tab-btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            .filter-bar {
                flex-direction: column;
            }

            .filter-select, .filter-input {
                width: 100%;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div id="header-container"></div>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">
                ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
                <span class="role-badge">Admin</span>
            </h1>
            <p class="page-subtitle">í”Œë«í¼ ì „ì²´ í˜„í™© ë° ê´€ë¦¬</p>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('dashboard', this)">ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab-btn" onclick="switchTab('projects', this)">í”„ë¡œì íŠ¸ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('payments', this)">ì…ê¸ˆ ê´€ë¦¬ <span class="tab-badge" id="paymentBadge">0</span></button>
            <button class="tab-btn" onclick="switchTab('revisions', this)">ìˆ˜ì • ìš”ì²­ <span class="tab-badge" id="revisionBadge">0</span></button>
            <button class="tab-btn" onclick="switchTab('delivery', this)">ë³´ê³ ì„œ ìˆ˜ë ¹ <span class="tab-badge" id="deliveryBadge">0</span></button>
            <button class="tab-btn" onclick="switchTab('users', this)">ì‚¬ìš©ì ê´€ë¦¬</button>
        </div>

        <!-- ========== íƒ­ 1: ëŒ€ì‹œë³´ë“œ ========== -->
        <div id="tab-dashboard" class="tab-panel active">
            <div class="stats-grid stats-grid-7">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">ğŸ“Š</div>
                        <div class="stat-label">ì´ í”„ë¡œì íŠ¸</div>
                    </div>
                    <div class="stat-value" id="totalProjects">0</div>
                    <div class="stat-subtext">ì§„í–‰ ì¤‘: <span id="inProgressCount">0</span></div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">ğŸ¢</div>
                        <div class="stat-label">ê³ ê°ì‚¬</div>
                    </div>
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-subtext">í™œì„± ì‚¬ìš©ì</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">ğŸ‘¨â€ğŸ’¼</div>
                        <div class="stat-label">ê³µì¸íšŒê³„ì‚¬</div>
                    </div>
                    <div class="stat-value" id="totalAccountants">0</div>
                    <div class="stat-subtext">ë°°ì • ê°€ëŠ¥: <span id="availableAccountants">0</span></div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">â³</div>
                        <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div>
                    </div>
                    <div class="stat-value" id="pendingApprovals">0</div>
                    <div class="stat-subtext">ê²€í†  í•„ìš”</div>
                </div>

                <div class="stat-card alert">
                    <div class="stat-header">
                        <div class="stat-icon">ğŸ’°</div>
                        <div class="stat-label">ì…ê¸ˆ ëŒ€ê¸°</div>
                    </div>
                    <div class="stat-value" id="pendingPayments">0</div>
                    <div class="stat-subtext">í™•ì¸ í•„ìš”</div>
                </div>

                <div class="stat-card alert">
                    <div class="stat-header">
                        <div class="stat-icon">ğŸ“</div>
                        <div class="stat-label">ìˆ˜ì • ìš”ì²­</div>
                    </div>
                    <div class="stat-value" id="pendingRevisions">0</div>
                    <div class="stat-subtext">ì²˜ë¦¬ í•„ìš”</div>
                </div>

                <div class="stat-card alert">
                    <div class="stat-header">
                        <div class="stat-icon">ğŸ“¦</div>
                        <div class="stat-label">ìˆ˜ë ¹ ëŒ€ê¸°</div>
                    </div>
                    <div class="stat-value" id="pendingDeliveries">0</div>
                    <div class="stat-subtext">ë°°ì†¡ í•„ìš”</div>
                </div>
            </div>

            <div class="grid-2">
                <!-- ìµœê·¼ í”„ë¡œì íŠ¸ -->
                <div class="section">
                    <h2 class="section-title">ìµœê·¼ í”„ë¡œì íŠ¸</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>íšŒì‚¬ëª…</th>
                                <th>ìƒíƒœ</th>
                                <th>ë‹¨ê³„</th>
                            </tr>
                        </thead>
                        <tbody id="recentProjectsTable">
                            <tr><td colspan="4" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ìµœê·¼ ê°€ì… ê³ ê° -->
                <div class="section">
                    <h2 class="section-title">ìµœê·¼ ê°€ì… ê³ ê°</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ê°€ì…ì¼</th>
                            </tr>
                        </thead>
                        <tbody id="recentUsersTable">
                            <tr><td colspan="3" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ì£¼ì˜ í•„ìš” í•­ëª© -->
            <div class="section">
                <h2 class="section-title">ìŠ¹ì¸ ëŒ€ê¸° í”„ë¡œì íŠ¸</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>í”„ë¡œì íŠ¸ ID</th>
                            <th>íšŒì‚¬ëª…</th>
                            <th>í‰ê°€ ë°©ë²•</th>
                            <th>ì˜ˆì‚°</th>
                            <th>ì‹ ì²­ì¼</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="pendingProjectsTable">
                        <tr><td colspan="6" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== íƒ­ 2: í”„ë¡œì íŠ¸ ê´€ë¦¬ ========== -->
        <div id="tab-projects" class="tab-panel">
            <div class="section">
                <h2 class="section-title">í”„ë¡œì íŠ¸ ê´€ë¦¬</h2>
                <div class="filter-bar">
                    <select class="filter-select" id="projectFilterStatus" onchange="loadAllProjects()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="pending">ëŒ€ê¸°</option>
                        <option value="approved">ìŠ¹ì¸ë¨</option>
                        <option value="in_progress">ì§„í–‰ ì¤‘</option>
                        <option value="completed">ì™„ë£Œ</option>
                    </select>
                    <select class="filter-select" id="projectFilterMethod" onchange="loadAllProjects()">
                        <option value="">ì „ì²´ í‰ê°€ë²•</option>
                        <option value="DCF">DCF</option>
                        <option value="market_approach">ì‹œì¥ì ‘ê·¼ë²•</option>
                        <option value="asset_approach">ìì‚°ì ‘ê·¼ë²•</option>
                    </select>
                    <input class="filter-input" type="text" id="projectFilterSearch" placeholder="íšŒì‚¬ëª… ê²€ìƒ‰..." oninput="debounce('projects', loadAllProjects, 300)">
                    <button class="btn btn-secondary btn-sm export-btn" onclick="exportProjects()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>íšŒì‚¬ëª…</th>
                                <th>í‰ê°€ë²•</th>
                                <th>ìƒíƒœ</th>
                                <th>íšŒê³„ì‚¬</th>
                                <th>ìŠ¹ì¸ ê¸ˆì•¡</th>
                                <th>ë‹¨ê³„</th>
                                <th>ìƒì„±ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="allProjectsTable">
                            <tr><td colspan="9" class="empty-state">íƒ­ì„ ì„ íƒí•˜ë©´ ë¡œë“œë©ë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="projectsPagination" class="pagination"></div>
            </div>
        </div>

        <!-- ========== íƒ­ 3: ì…ê¸ˆ ê´€ë¦¬ ========== -->
        <div id="tab-payments" class="tab-panel">
            <div class="section">
                <h2 class="section-title">ì…ê¸ˆ ê´€ë¦¬ (ì”ê¸ˆ)</h2>
                <div class="filter-bar">
                    <select class="filter-select" id="paymentFilterStatus" onchange="loadPayments()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="pending">ëŒ€ê¸°</option>
                        <option value="confirmed">í™•ì¸ ì™„ë£Œ</option>
                    </select>
                    <button class="btn btn-secondary btn-sm export-btn" onclick="exportPayments()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>í”„ë¡œì íŠ¸</th>
                                <th>í‰ê°€ë²•</th>
                                <th>ì…ê¸ˆì</th>
                                <th>ê¸ˆì•¡</th>
                                <th>ìƒíƒœ</th>
                                <th>ìš”ì²­ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <tr><td colspan="8" class="empty-state">íƒ­ì„ ì„ íƒí•˜ë©´ ë¡œë“œë©ë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="paymentsPagination" class="pagination"></div>
            </div>
        </div>

        <!-- ========== íƒ­ 4: ìˆ˜ì • ìš”ì²­ ========== -->
        <div id="tab-revisions" class="tab-panel">
            <div class="section">
                <h2 class="section-title">ìˆ˜ì • ìš”ì²­ ê´€ë¦¬</h2>
                <div class="filter-bar">
                    <select class="filter-select" id="revisionFilterStatus" onchange="loadRevisions()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="ì ‘ìˆ˜ë¨">ì ‘ìˆ˜ë¨</option>
                        <option value="ì²˜ë¦¬ì¤‘">ì²˜ë¦¬ì¤‘</option>
                        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                    </select>
                    <button class="btn btn-secondary btn-sm export-btn" onclick="exportRevisions()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>í”„ë¡œì íŠ¸</th>
                                <th>í‰ê°€ë²•</th>
                                <th>ì„¹ì…˜</th>
                                <th>ìœ í˜•</th>
                                <th>ìƒíƒœ</th>
                                <th>ìš”ì²­ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="revisionsTable">
                            <tr><td colspan="8" class="empty-state">íƒ­ì„ ì„ íƒí•˜ë©´ ë¡œë“œë©ë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="revisionsPagination" class="pagination"></div>
            </div>
        </div>

        <!-- ========== íƒ­ 5: ë³´ê³ ì„œ ìˆ˜ë ¹ ========== -->
        <div id="tab-delivery" class="tab-panel">
            <div class="section">
                <h2 class="section-title">ë³´ê³ ì„œ ìˆ˜ë ¹ ê´€ë¦¬</h2>
                <div class="filter-bar">
                    <select class="filter-select" id="deliveryFilterStatus" onchange="loadDeliveries()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="pending">ì ‘ìˆ˜</option>
                        <option value="processing">ì²˜ë¦¬ì¤‘</option>
                        <option value="completed">ì™„ë£Œ</option>
                    </select>
                    <select class="filter-select" id="deliveryFilterType" onchange="loadDeliveries()">
                        <option value="">ì „ì²´ ìœ í˜•</option>
                        <option value="email">ì´ë©”ì¼</option>
                        <option value="hardcopy">ìš°í¸</option>
                    </select>
                    <button class="btn btn-secondary btn-sm export-btn" onclick="exportDeliveries()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>í”„ë¡œì íŠ¸</th>
                                <th>í‰ê°€ë²•</th>
                                <th>ìœ í˜•</th>
                                <th>ìˆ˜ë ¹ì¸</th>
                                <th>ìƒíƒœ</th>
                                <th>ìš”ì²­ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="deliveriesTable">
                            <tr><td colspan="8" class="empty-state">íƒ­ì„ ì„ íƒí•˜ë©´ ë¡œë“œë©ë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="deliveriesPagination" class="pagination"></div>
            </div>
        </div>

        <!-- ========== íƒ­ 6: ì‚¬ìš©ì ê´€ë¦¬ ========== -->
        <div id="tab-users" class="tab-panel">
            <div class="section">
                <h2 class="section-title">ì‚¬ìš©ì ê´€ë¦¬</h2>
                <div class="filter-bar">
                    <select class="filter-select" id="userFilterRole" onchange="loadUsers()">
                        <option value="">ì „ì²´ ì—­í• </option>
                        <option value="customer">ê³ ê°</option>
                        <option value="accountant">íšŒê³„ì‚¬</option>
                        <option value="admin">ê´€ë¦¬ì</option>
                    </select>
                    <input class="filter-input" type="text" id="userFilterSearch" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..." oninput="debounce('users', loadUsers, 300)">
                    <button class="btn btn-secondary btn-sm" onclick="exportUsers()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">+ ì‚¬ìš©ì ì¶”ê°€</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì—­í• </th>
                                <th>í™œì„±</th>
                                <th>ê°€ì…ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="6" class="empty-state">íƒ­ì„ ì„ íƒí•˜ë©´ ë¡œë“œë©ë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="usersPagination" class="pagination"></div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ -->
    <div id="modalOverlay" class="modal-overlay" onclick="if(event.target===this)closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ëª¨ë‹¬</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        // ==================== ì´ˆê¸°í™” ====================
        let supabase = null;
        try {
            const SUPABASE_URL = 'https://arxrfetgaitkgiiqabap.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeHJmZXRnYWl0a2dpaXFhYmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1OTgsImV4cCI6MjA4NDM2NTU5OH0.BTnuv0sYr2MGe1c-gk8PWCviwkFyIiymfKp5Jhzwbo0';
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) { console.warn('Supabase ì´ˆê¸°í™” ìŠ¤í‚µ'); }

        // íƒ­ë³„ ë¡œë“œ ìƒíƒœ
        const tabLoaded = {
            dashboard: false,
            projects: false,
            payments: false,
            revisions: false,
            delivery: false,
            users: false
        };

        // í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ
        const PAGE_SIZE = 15;
        const pageState = {
            projects: 1,
            payments: 1,
            revisions: 1,
            delivery: 1,
            users: 1
        };

        // ==================== í—¤ë” ë¡œë“œ ====================
        fetch('../../components/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
                const scripts = document.getElementById('header-container').querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });
            });

        // ==================== í˜ì´ì§€ ì´ˆê¸°í™” ====================
        window.addEventListener('DOMContentLoaded', async () => {
            await initAdmin();
        });

        async function initAdmin() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '../login.html';
                    return;
                }

                const { data: userData } = await supabase
                    .from('users')
                    .select('role')
                    .eq('user_id', user.id)
                    .single();

                if (userData?.role !== 'admin') {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '../../index.html';
                    return;
                }

                await loadDashboard();
            } catch (error) {
                console.error('Admin init error:', error);
            }
        }

        // ==================== íƒ­ ì „í™˜ ====================
        function switchTab(tabName, btn) {
            // íŒ¨ë„ ì „í™˜
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            // ë²„íŠ¼ ì „í™˜
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // lazy load
            if (!tabLoaded[tabName]) {
                tabLoaded[tabName] = true;
                switch(tabName) {
                    case 'dashboard': loadDashboard(); break;
                    case 'projects': loadAllProjects(); break;
                    case 'payments': loadPayments(); break;
                    case 'revisions': loadRevisions(); break;
                    case 'delivery': loadDeliveries(); break;
                    case 'users': loadUsers(); break;
                }
            }
        }

        // ==================== ëª¨ë‹¬ ì‹œìŠ¤í…œ ====================
        function showModal(title, bodyHtml, footerHtml) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('modalFooter').innerHTML = footerHtml || '';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // ==================== í˜ì´ì§€ë„¤ì´ì…˜ ====================
        function renderPagination(containerId, totalCount, currentPage, loadFn) {
            const totalPages = Math.ceil(totalCount / PAGE_SIZE);
            const container = document.getElementById(containerId);
            if (totalPages <= 1) { container.innerHTML = ''; return; }

            let html = '';
            html += `<button class="page-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="${loadFn}(${currentPage - 1})">&laquo;</button>`;

            const start = Math.max(1, currentPage - 2);
            const end = Math.min(totalPages, currentPage + 2);

            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="${loadFn}(${i})">${i}</button>`;
            }

            html += `<button class="page-btn" ${currentPage >= totalPages ? 'disabled' : ''} onclick="${loadFn}(${currentPage + 1})">&raquo;</button>`;
            container.innerHTML = html;
        }

        // ==================== XSS ë°©ì§€ ====================
        function esc(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escAttr(str) {
            return esc(str);
        }

        // ==================== ë¡œë”© & Toast ====================
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
            toast.innerHTML = `<span style="font-size:20px;">${icon}</span><span>${esc(message)}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== Debounce ====================
        let debounceTimers = {};
        function debounce(key, fn, delay = 300) {
            clearTimeout(debounceTimers[key]);
            debounceTimers[key] = setTimeout(fn, delay);
        }

        // ==================== CSV ë‚´ë³´ë‚´ê¸° ====================
        function exportToCSV(data, filename, columns) {
            if (!data || data.length === 0) {
                showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const headers = columns.map(c => c.label).join(',');
            const rows = data.map(row =>
                columns.map(c => {
                    let val = c.key.split('.').reduce((o, k) => o?.[k], row) || '';
                    // CSV ì´ìŠ¤ì¼€ì´í•‘
                    val = String(val).replace(/"/g, '""');
                    return `"${val}"`;
                }).join(',')
            ).join('\n');

            const csv = headers + '\n' + rows;
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            URL.revokeObjectURL(link.href);
            showToast('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ==================== ìœ í‹¸ë¦¬í‹° ====================
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('ko-KR');
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '-';
            return Number(amount).toLocaleString('ko-KR') + 'ì›';
        }

        function getStatusClass(status) {
            const map = {
                'pending': 'pending', 'approved': 'progress', 'in_progress': 'progress',
                'completed': 'completed', 'confirmed': 'confirmed', 'rejected': 'rejected',
                'processing': 'processing',
                'ì ‘ìˆ˜ë¨': 'pending', 'ì²˜ë¦¬ì¤‘': 'processing', 'ì™„ë£Œ': 'completed'
            };
            return map[status] || 'pending';
        }

        function getStatusText(status) {
            const map = {
                'pending': 'ëŒ€ê¸°', 'approved': 'ìŠ¹ì¸ë¨', 'in_progress': 'ì§„í–‰ ì¤‘',
                'completed': 'ì™„ë£Œ', 'confirmed': 'í™•ì¸ ì™„ë£Œ', 'rejected': 'ê±°ë¶€',
                'processing': 'ì²˜ë¦¬ì¤‘',
                'ì ‘ìˆ˜ë¨': 'ì ‘ìˆ˜ë¨', 'ì²˜ë¦¬ì¤‘': 'ì²˜ë¦¬ì¤‘', 'ì™„ë£Œ': 'ì™„ë£Œ'
            };
            return map[status] || status || '-';
        }

        function getDeliveryTypeText(type) {
            return type === 'email' ? 'ì´ë©”ì¼' : type === 'hardcopy' ? 'ìš°í¸' : type || '-';
        }

        // ==================== íƒ­ 1: ëŒ€ì‹œë³´ë“œ ====================
        async function loadDashboard() {
            tabLoaded.dashboard = true;
            try {
                await Promise.all([
                    loadStatistics(),
                    loadRecentProjects(),
                    loadRecentUsers(),
                    loadPendingProjects()
                ]);
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        async function loadStatistics() {
            const [
                { data: projects },
                { count: customerCount },
                { data: accountants },
                { count: pendingPaymentCount },
                { count: pendingRevisionCount },
                { count: pendingDeliveryCount }
            ] = await Promise.all([
                supabase.from('projects').select('status'),
                supabase.from('users').select('*', { count: 'exact', head: true }).eq('role', 'customer').eq('is_active', true),
                supabase.from('accountants').select('is_available'),
                supabase.from('balance_payments').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
                supabase.from('revision_requests').select('*', { count: 'exact', head: true }).in('status', ['ì ‘ìˆ˜ë¨', 'ì²˜ë¦¬ì¤‘']),
                supabase.from('report_delivery_requests').select('*', { count: 'exact', head: true }).in('status', ['pending', 'processing'])
            ]);

            document.getElementById('totalProjects').textContent = projects?.length || 0;
            document.getElementById('inProgressCount').textContent = projects?.filter(p => p.status === 'in_progress').length || 0;
            document.getElementById('pendingApprovals').textContent = projects?.filter(p => p.status === 'pending').length || 0;
            document.getElementById('totalCustomers').textContent = customerCount || 0;
            document.getElementById('totalAccountants').textContent = accountants?.length || 0;
            document.getElementById('availableAccountants').textContent = accountants?.filter(a => a.is_available).length || 0;

            document.getElementById('pendingPayments').textContent = pendingPaymentCount || 0;
            document.getElementById('pendingRevisions').textContent = pendingRevisionCount || 0;
            document.getElementById('pendingDeliveries').textContent = pendingDeliveryCount || 0;

            // íƒ­ ë±ƒì§€ ì—…ë°ì´íŠ¸
            document.getElementById('paymentBadge').textContent = pendingPaymentCount || 0;
            document.getElementById('revisionBadge').textContent = pendingRevisionCount || 0;
            document.getElementById('deliveryBadge').textContent = pendingDeliveryCount || 0;
        }

        async function loadRecentProjects() {
            const { data: projects } = await supabase
                .from('projects')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            if (!projects || projects.length === 0) {
                document.getElementById('recentProjectsTable').innerHTML = `<tr><td colspan="4" class="empty-state">ë°ì´í„° ì—†ìŒ</td></tr>`;
                return;
            }

            document.getElementById('recentProjectsTable').innerHTML = projects.map(p => `
                <tr>
                    <td><a href="../projects/project-detail.html?id=${escAttr(p.project_id)}" class="link">${esc(p.project_id)}</a></td>
                    <td>${esc(p.company_name_kr || p.company_name || '-')}</td>
                    <td><span class="status-badge status-${getStatusClass(p.status)}">${getStatusText(p.status)}</span></td>
                    <td>Step ${p.current_step || 1}</td>
                </tr>
            `).join('');
        }

        async function loadRecentUsers() {
            const { data: users } = await supabase
                .from('users')
                .select('name, email, created_at')
                .eq('role', 'customer')
                .order('created_at', { ascending: false })
                .limit(5);

            if (!users || users.length === 0) {
                document.getElementById('recentUsersTable').innerHTML = `<tr><td colspan="3" class="empty-state">ë°ì´í„° ì—†ìŒ</td></tr>`;
                return;
            }

            document.getElementById('recentUsersTable').innerHTML = users.map(u => `
                <tr>
                    <td>${esc(u.name || '-')}</td>
                    <td>${esc(u.email)}</td>
                    <td>${formatDate(u.created_at)}</td>
                </tr>
            `).join('');
        }

        async function loadPendingProjects() {
            const { data: projects } = await supabase
                .from('projects')
                .select('*')
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            if (!projects || projects.length === 0) {
                document.getElementById('pendingProjectsTable').innerHTML = `<tr><td colspan="6" class="empty-state">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            document.getElementById('pendingProjectsTable').innerHTML = projects.map(p => `
                <tr>
                    <td><a href="../projects/project-detail.html?id=${escAttr(p.project_id)}" class="link">${esc(p.project_id)}</a></td>
                    <td>${esc(p.company_name_kr || p.company_name || '-')}</td>
                    <td>${esc(p.valuation_method || '-')}</td>
                    <td>${p.budget ? formatCurrency(p.budget) : '-'}</td>
                    <td>${formatDate(p.created_at)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="handleApproval('${escAttr(p.project_id)}', 'approve')">ìŠ¹ì¸</button>
                        <button class="btn btn-secondary btn-sm" onclick="handleApproval('${escAttr(p.project_id)}', 'reject')">ê±°ë¶€</button>
                    </td>
                </tr>
            `).join('');
        }

        async function handleApproval(projectId, action) {
            const msg = action === 'approve' ? 'ì´ í”„ë¡œì íŠ¸ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì´ í”„ë¡œì íŠ¸ë¥¼ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            if (!confirm(msg)) return;

            const newStatus = action === 'approve' ? 'approved' : 'rejected';
            const { error } = await supabase
                .from('projects')
                .update({ status: newStatus })
                .eq('project_id', projectId);

            if (error) {
                showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                console.error(error);
                return;
            }

            showToast(action === 'approve' ? 'ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await loadDashboard();
        }

        // ==================== íƒ­ 2: í”„ë¡œì íŠ¸ ê´€ë¦¬ ====================
        async function loadAllProjects(page) {
            showLoading();
            try {
                if (page) pageState.projects = page;
                const currentPage = pageState.projects;

                const status = document.getElementById('projectFilterStatus').value;
                const method = document.getElementById('projectFilterMethod').value;
                const search = document.getElementById('projectFilterSearch').value.trim();

                let query = supabase.from('projects').select('*', { count: 'exact' });
                if (status) query = query.eq('status', status);
                if (method) query = query.eq('valuation_method', method);
                if (search) query = query.or(`company_name_kr.ilike.%${search}%,company_name.ilike.%${search}%`);

                query = query.order('created_at', { ascending: false })
                    .range((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE - 1);

                const { data: projects, count } = await query;

                if (!projects || projects.length === 0) {
                    document.getElementById('allProjectsTable').innerHTML = `<tr><td colspan="9" class="empty-state">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    document.getElementById('projectsPagination').innerHTML = '';
                    hideLoading();
                    return;
                }

                document.getElementById('allProjectsTable').innerHTML = projects.map(p => `
                    <tr>
                        <td><a href="../projects/project-detail.html?id=${escAttr(p.project_id)}" class="link">${esc(p.project_id)}</a></td>
                        <td>${esc(p.company_name_kr || p.company_name || '-')}</td>
                        <td>${esc(p.valuation_method || '-')}</td>
                        <td><span class="status-badge status-${getStatusClass(p.status)}">${getStatusText(p.status)}</span></td>
                        <td>${esc(p.assigned_accountant || '-')}</td>
                        <td>${p.agreed_price ? formatCurrency(p.agreed_price) : '-'}</td>
                        <td>Step ${p.current_step || 1}</td>
                        <td>${formatDate(p.created_at)}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="showProjectDetailModal('${escAttr(p.project_id)}')">ìƒì„¸</button>
                        </td>
                    </tr>
                `).join('');

                renderPagination('projectsPagination', count, currentPage, 'loadAllProjects');
            } finally {
                hideLoading();
            }
        }

        async function showProjectDetailModal(projectId) {
            const { data: project } = await supabase
                .from('projects')
                .select('*')
                .eq('project_id', projectId)
                .single();

            if (!project) { showToast('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }

            // í‰ê°€ë²•ë³„ draft ìƒíƒœ ì¡°íšŒ
            const { data: draftStatuses } = await supabase
                .from('draft_method_status')
                .select('*')
                .eq('project_id', projectId);

            // íšŒê³„ì‚¬ ëª©ë¡ ì¡°íšŒ
            const { data: accountants } = await supabase
                .from('accountants')
                .select('name, email, specialty');

            const draftHtml = draftStatuses && draftStatuses.length > 0
                ? draftStatuses.map(d => `
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #F3F4F6;">
                        <span style="font-weight:600;">${esc(d.method)}</span>
                        <span class="status-badge status-${getStatusClass(d.draft_status)}">${getStatusText(d.draft_status) || esc(d.draft_status)}</span>
                    </div>
                `).join('')
                : '<p style="color:#6B7280;">ì´ˆì•ˆ ìƒíƒœ ì •ë³´ ì—†ìŒ</p>';

            const accountantOptions = (accountants || []).map(a =>
                `<option value="${escAttr(a.name)}" ${project.assigned_accountant === a.name ? 'selected' : ''}>${esc(a.name)} (${esc(a.specialty || '-')})</option>`
            ).join('');

            const bodyHtml = `
                <dl class="info-grid">
                    <dt>í”„ë¡œì íŠ¸ ID</dt><dd>${esc(project.project_id)}</dd>
                    <dt>íšŒì‚¬ëª…</dt><dd>${esc(project.company_name_kr || project.company_name || '-')}</dd>
                    <dt>í‰ê°€ë²•</dt><dd>${esc(project.valuation_method || '-')}</dd>
                    <dt>ìƒíƒœ</dt><dd><span class="status-badge status-${getStatusClass(project.status)}">${getStatusText(project.status)}</span></dd>
                    <dt>í˜„ì¬ ë‹¨ê³„</dt><dd>Step ${project.current_step || 1}</dd>
                    <dt>ìƒì„±ì¼</dt><dd>${formatDate(project.created_at)}</dd>
                </dl>
                <hr style="margin:20px 0;border:none;border-top:1px solid #E5E7EB;">
                <h4 style="margin-bottom:12px;font-size:15px;">í‰ê°€ë²•ë³„ ì´ˆì•ˆ ìƒíƒœ</h4>
                ${draftHtml}
                <hr style="margin:20px 0;border:none;border-top:1px solid #E5E7EB;">
                <div class="form-group">
                    <label>ìŠ¹ì¸ ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="modalAgreedPrice" value="${project.agreed_price || ''}" placeholder="ì˜ˆ: 3000000">
                </div>
                <div class="form-group">
                    <label>ì„ ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="modalDepositAmount" value="${project.deposit_amount || ''}" placeholder="ì˜ˆ: 1500000">
                </div>
                <div class="form-group">
                    <label>ë‹´ë‹¹ íšŒê³„ì‚¬</label>
                    <select id="modalAccountant">
                        <option value="">-- ì„ íƒ --</option>
                        ${accountantOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>ìƒíƒœ ë³€ê²½</label>
                    <select id="modalProjectStatus">
                        <option value="pending" ${project.status === 'pending' ? 'selected' : ''}>ëŒ€ê¸°</option>
                        <option value="approved" ${project.status === 'approved' ? 'selected' : ''}>ìŠ¹ì¸ë¨</option>
                        <option value="in_progress" ${project.status === 'in_progress' ? 'selected' : ''}>ì§„í–‰ ì¤‘</option>
                        <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>ì™„ë£Œ</option>
                    </select>
                </div>
            `;

            const footerHtml = `
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveProjectDetail('${escAttr(projectId)}')">ì €ì¥</button>
            `;

            showModal('í”„ë¡œì íŠ¸ ìƒì„¸ - ' + esc(projectId), bodyHtml, footerHtml);
        }

        async function saveProjectDetail(projectId) {
            const agreedPrice = document.getElementById('modalAgreedPrice').value;
            const depositAmount = document.getElementById('modalDepositAmount').value;
            const accountant = document.getElementById('modalAccountant').value;
            const status = document.getElementById('modalProjectStatus').value;

            const updateData = { status };
            if (agreedPrice) updateData.agreed_price = parseInt(agreedPrice);
            if (depositAmount) updateData.deposit_amount = parseInt(depositAmount);
            if (accountant) updateData.assigned_accountant = accountant;

            const { error } = await supabase
                .from('projects')
                .update(updateData)
                .eq('project_id', projectId);

            if (error) {
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
                return;
            }

            showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal();
            loadAllProjects();
        }

        // ==================== íƒ­ 3: ì…ê¸ˆ ê´€ë¦¬ ====================
        async function loadPayments(page) {
            showLoading();
            try {
                if (page) pageState.payments = page;
                const currentPage = pageState.payments;

                const status = document.getElementById('paymentFilterStatus').value;

                let query = supabase.from('balance_payments').select('*', { count: 'exact' });
                if (status) query = query.eq('status', status);

                query = query.order('created_at', { ascending: false })
                    .range((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE - 1);

                const { data: payments, count } = await query;

                if (!payments || payments.length === 0) {
                    document.getElementById('paymentsTable').innerHTML = `<tr><td colspan="8" class="empty-state">ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    document.getElementById('paymentsPagination').innerHTML = '';
                    hideLoading();
                    return;
                }

            document.getElementById('paymentsTable').innerHTML = payments.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td><a href="../projects/project-detail.html?id=${escAttr(p.project_id)}" class="link">${esc(p.project_id)}</a></td>
                    <td>${esc(p.method || '-')}</td>
                    <td>${esc(p.depositor_name || '-')}</td>
                    <td>${formatCurrency(p.amount)}</td>
                    <td><span class="status-badge status-${getStatusClass(p.status)}">${getStatusText(p.status)}</span></td>
                    <td>${formatDate(p.created_at)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="showPaymentDetailModal(${p.id})">ìƒì„¸</button>
                        ${p.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="confirmPayment(${p.id})">ì…ê¸ˆ í™•ì¸</button>` : ''}
                    </td>
                </tr>
            `).join('');

                renderPagination('paymentsPagination', count, currentPage, 'loadPayments');
            } finally {
                hideLoading();
            }
        }

        async function showPaymentDetailModal(paymentId) {
            const { data: payment } = await supabase
                .from('balance_payments')
                .select('*')
                .eq('id', paymentId)
                .single();

            if (!payment) return;

            const bodyHtml = `
                <dl class="info-grid">
                    <dt>ID</dt><dd>${payment.id}</dd>
                    <dt>í”„ë¡œì íŠ¸</dt><dd><a href="../projects/project-detail.html?id=${escAttr(payment.project_id)}" class="link">${esc(payment.project_id)}</a></dd>
                    <dt>í‰ê°€ë²•</dt><dd>${esc(payment.method || '-')}</dd>
                    <dt>ì…ê¸ˆìëª…</dt><dd>${esc(payment.depositor_name)}</dd>
                    <dt>ê¸ˆì•¡</dt><dd style="font-weight:700;color:#DC2626;">${formatCurrency(payment.amount)}</dd>
                    <dt>ì€í–‰</dt><dd>${esc(payment.bank_name || '-')}</dd>
                    <dt>ê³„ì¢Œë²ˆí˜¸</dt><dd>${esc(payment.account_number || '-')}</dd>
                    <dt>ìš”ì²­ì</dt><dd>${esc(payment.requested_name || '-')}</dd>
                    <dt>ìƒíƒœ</dt><dd><span class="status-badge status-${getStatusClass(payment.status)}">${getStatusText(payment.status)}</span></dd>
                    <dt>ìš”ì²­ì¼</dt><dd>${formatDate(payment.created_at)}</dd>
                    <dt>í™•ì¸ì¼</dt><dd>${payment.confirmed_at ? formatDate(payment.confirmed_at) : '-'}</dd>
                </dl>
            `;

            const footerHtml = payment.status === 'pending'
                ? `<button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
                   <button class="btn btn-success" onclick="confirmPayment(${payment.id})">ì…ê¸ˆ í™•ì¸</button>`
                : `<button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>`;

            showModal('ì…ê¸ˆ ìƒì„¸ - #' + payment.id, bodyHtml, footerHtml);
        }

        async function confirmPayment(paymentId) {
            if (!confirm('ì…ê¸ˆì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

            const { data: { user } } = await supabase.auth.getUser();

            const { error } = await supabase
                .from('balance_payments')
                .update({
                    status: 'confirmed',
                    confirmed_at: new Date().toISOString(),
                    confirmed_by: user?.email || 'admin'
                })
                .eq('id', paymentId);

            if (error) {
                showToast('ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
                return;
            }

            showToast('ì…ê¸ˆì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal();
            loadPayments();
            // ëŒ€ì‹œë³´ë“œ í†µê³„ë„ ê°±ì‹ 
            loadStatistics();
        }

        // ==================== íƒ­ 4: ìˆ˜ì • ìš”ì²­ ====================
        async function loadRevisions(page) {
            showLoading();
            try {
                if (page) pageState.revisions = page;
                const currentPage = pageState.revisions;

                const status = document.getElementById('revisionFilterStatus').value;

                let query = supabase.from('revision_requests').select('*', { count: 'exact' });
                if (status) query = query.eq('status', status);

                query = query.order('created_at', { ascending: false })
                    .range((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE - 1);

                const { data: revisions, count } = await query;

                if (!revisions || revisions.length === 0) {
                    document.getElementById('revisionsTable').innerHTML = `<tr><td colspan="8" class="empty-state">ìˆ˜ì • ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    document.getElementById('revisionsPagination').innerHTML = '';
                    hideLoading();
                    return;
                }

            document.getElementById('revisionsTable').innerHTML = revisions.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td><a href="../projects/project-detail.html?id=${escAttr(r.project_id)}" class="link">${esc(r.project_id)}</a></td>
                    <td>${esc(r.method || '-')}</td>
                    <td>${esc(r.section || '-')}</td>
                    <td>${esc(r.request_type || '-')}</td>
                    <td><span class="status-badge status-${getStatusClass(r.status)}">${getStatusText(r.status)}</span></td>
                    <td>${formatDate(r.created_at)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="showRevisionDetailModal(${r.id})">ìƒì„¸</button>
                    </td>
                </tr>
            `).join('');

                renderPagination('revisionsPagination', count, currentPage, 'loadRevisions');
            } finally {
                hideLoading();
            }
        }

        async function showRevisionDetailModal(revisionId) {
            const { data: revision } = await supabase
                .from('revision_requests')
                .select('*')
                .eq('id', revisionId)
                .single();

            if (!revision) return;

            const attachHtml = revision.attachment_urls && revision.attachment_urls.length > 0
                ? revision.attachment_urls.map((url, i) => `<a href="${escAttr(url)}" target="_blank" class="link">ì²¨ë¶€íŒŒì¼ ${i + 1}</a>`).join(', ')
                : 'ì—†ìŒ';

            const bodyHtml = `
                <dl class="info-grid">
                    <dt>ID</dt><dd>${revision.id}</dd>
                    <dt>í”„ë¡œì íŠ¸</dt><dd><a href="../projects/project-detail.html?id=${escAttr(revision.project_id)}" class="link">${esc(revision.project_id)}</a></dd>
                    <dt>í‰ê°€ë²•</dt><dd>${esc(revision.method || '-')}</dd>
                    <dt>ì„¹ì…˜</dt><dd>${esc(revision.section)}</dd>
                    <dt>ìœ í˜•</dt><dd>${esc(revision.request_type)}</dd>
                    <dt>ìƒíƒœ</dt><dd><span class="status-badge status-${getStatusClass(revision.status)}">${getStatusText(revision.status)}</span></dd>
                    <dt>ìš”ì²­ì¼</dt><dd>${formatDate(revision.created_at)}</dd>
                    <dt>ì²¨ë¶€íŒŒì¼</dt><dd>${attachHtml}</dd>
                </dl>
                <hr style="margin:20px 0;border:none;border-top:1px solid #E5E7EB;">
                <h4 style="margin-bottom:8px;font-size:15px;">ìš”ì²­ ë‚´ìš©</h4>
                <p style="font-size:14px;line-height:1.7;color:#374151;background:#F9FAFB;padding:16px;border-radius:8px;white-space:pre-wrap;">${esc(revision.request_detail || '-')}</p>
                <hr style="margin:20px 0;border:none;border-top:1px solid #E5E7EB;">
                <div class="form-group">
                    <label>ìƒíƒœ ë³€ê²½</label>
                    <select id="modalRevisionStatus">
                        <option value="ì ‘ìˆ˜ë¨" ${revision.status === 'ì ‘ìˆ˜ë¨' ? 'selected' : ''}>ì ‘ìˆ˜ë¨</option>
                        <option value="ì²˜ë¦¬ì¤‘" ${revision.status === 'ì²˜ë¦¬ì¤‘' ? 'selected' : ''}>ì²˜ë¦¬ì¤‘</option>
                        <option value="ì™„ë£Œ" ${revision.status === 'ì™„ë£Œ' ? 'selected' : ''}>ì™„ë£Œ</option>
                    </select>
                </div>
            `;

            const footerHtml = `
                <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="updateRevisionStatus(${revision.id})">ìƒíƒœ ì €ì¥</button>
            `;

            showModal('ìˆ˜ì • ìš”ì²­ ìƒì„¸ - #' + revision.id, bodyHtml, footerHtml);
        }

        async function updateRevisionStatus(revisionId) {
            const newStatus = document.getElementById('modalRevisionStatus').value;

            const { error } = await supabase
                .from('revision_requests')
                .update({ status: newStatus })
                .eq('id', revisionId);

            if (error) {
                showToast('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
                return;
            }

            showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal();
            loadRevisions();
            loadStatistics();
        }

        // ==================== íƒ­ 5: ë³´ê³ ì„œ ìˆ˜ë ¹ ====================
        async function loadDeliveries(page) {
            showLoading();
            try {
                if (page) pageState.delivery = page;
                const currentPage = pageState.delivery;

                const status = document.getElementById('deliveryFilterStatus').value;
                const type = document.getElementById('deliveryFilterType').value;

                let query = supabase.from('report_delivery_requests').select('*', { count: 'exact' });
                if (status) query = query.eq('status', status);
                if (type) query = query.eq('delivery_type', type);

                query = query.order('created_at', { ascending: false })
                    .range((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE - 1);

                const { data: deliveries, count } = await query;

                if (!deliveries || deliveries.length === 0) {
                    document.getElementById('deliveriesTable').innerHTML = `<tr><td colspan="8" class="empty-state">ìˆ˜ë ¹ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    document.getElementById('deliveriesPagination').innerHTML = '';
                    hideLoading();
                    return;
                }

            document.getElementById('deliveriesTable').innerHTML = deliveries.map(d => `
                <tr>
                    <td>${d.id}</td>
                    <td><a href="../projects/project-detail.html?id=${escAttr(d.project_id)}" class="link">${esc(d.project_id)}</a></td>
                    <td>${esc(d.method || '-')}</td>
                    <td>${getDeliveryTypeText(d.delivery_type)}</td>
                    <td>${esc(d.recipient_name || d.email || '-')}</td>
                    <td><span class="status-badge status-${getStatusClass(d.status)}">${getStatusText(d.status)}</span></td>
                    <td>${formatDate(d.requested_at || d.created_at)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="showDeliveryDetailModal(${d.id})">ìƒì„¸</button>
                    </td>
                </tr>
            `).join('');

                renderPagination('deliveriesPagination', count, currentPage, 'loadDeliveries');
            } finally {
                hideLoading();
            }
        }

        async function showDeliveryDetailModal(deliveryId) {
            const { data: delivery } = await supabase
                .from('report_delivery_requests')
                .select('*')
                .eq('id', deliveryId)
                .single();

            if (!delivery) return;

            const isHardcopy = delivery.delivery_type === 'hardcopy';

            const bodyHtml = `
                <dl class="info-grid">
                    <dt>ID</dt><dd>${delivery.id}</dd>
                    <dt>í”„ë¡œì íŠ¸</dt><dd><a href="../projects/project-detail.html?id=${escAttr(delivery.project_id)}" class="link">${esc(delivery.project_id)}</a></dd>
                    <dt>í‰ê°€ë²•</dt><dd>${esc(delivery.method || '-')}</dd>
                    <dt>ìˆ˜ë ¹ ìœ í˜•</dt><dd>${getDeliveryTypeText(delivery.delivery_type)}</dd>
                    <dt>ìƒíƒœ</dt><dd><span class="status-badge status-${getStatusClass(delivery.status)}">${getStatusText(delivery.status)}</span></dd>
                    <dt>ìš”ì²­ì¼</dt><dd>${formatDate(delivery.requested_at || delivery.created_at)}</dd>
                    <dt>ì™„ë£Œì¼</dt><dd>${delivery.completed_at ? formatDate(delivery.completed_at) : '-'}</dd>
                    ${delivery.email ? `<dt>ì´ë©”ì¼</dt><dd>${esc(delivery.email)}</dd>` : ''}
                    ${isHardcopy ? `
                        <dt>ìˆ˜ë ¹ì¸</dt><dd>${esc(delivery.recipient_name || '-')}</dd>
                        <dt>ì—°ë½ì²˜</dt><dd>${esc(delivery.recipient_phone || '-')}</dd>
                        <dt>ìš°í¸ë²ˆí˜¸</dt><dd>${esc(delivery.zip_code || '-')}</dd>
                        <dt>ì£¼ì†Œ</dt><dd>${esc(delivery.address || '-')} ${esc(delivery.address_detail || '')}</dd>
                        <dt>ë¶€ìˆ˜</dt><dd>${delivery.copy_count || 1}ë¶€</dd>
                    ` : ''}
                </dl>
                <hr style="margin:20px 0;border:none;border-top:1px solid #E5E7EB;">
                <div class="form-group">
                    <label>ë°°ì†¡ ìƒíƒœ ë³€ê²½</label>
                    <select id="modalDeliveryStatus">
                        <option value="pending" ${delivery.status === 'pending' ? 'selected' : ''}>ì ‘ìˆ˜</option>
                        <option value="processing" ${delivery.status === 'processing' ? 'selected' : ''}>ì²˜ë¦¬ì¤‘</option>
                        <option value="completed" ${delivery.status === 'completed' ? 'selected' : ''}>ì™„ë£Œ</option>
                    </select>
                </div>
            `;

            const footerHtml = `
                <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="updateDeliveryStatus(${delivery.id})">ìƒíƒœ ì €ì¥</button>
            `;

            showModal('ìˆ˜ë ¹ ìš”ì²­ ìƒì„¸ - #' + delivery.id, bodyHtml, footerHtml);
        }

        async function updateDeliveryStatus(deliveryId) {
            const newStatus = document.getElementById('modalDeliveryStatus').value;
            const updateData = { status: newStatus };
            if (newStatus === 'completed') {
                updateData.completed_at = new Date().toISOString();
            }

            const { error } = await supabase
                .from('report_delivery_requests')
                .update(updateData)
                .eq('id', deliveryId);

            if (error) {
                showToast('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
                return;
            }

            showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal();
            loadDeliveries();
            loadStatistics();
        }

        // ==================== íƒ­ 6: ì‚¬ìš©ì ê´€ë¦¬ ====================
        async function loadUsers(page) {
            showLoading();
            try {
                if (page) pageState.users = page;
                const currentPage = pageState.users;

                const role = document.getElementById('userFilterRole').value;
                const search = document.getElementById('userFilterSearch').value.trim();

                let query = supabase.from('users').select('*', { count: 'exact' });
                if (role) query = query.eq('role', role);
                if (search) query = query.or(`name.ilike.%${search}%,email.ilike.%${search}%`);

                query = query.order('created_at', { ascending: false })
                    .range((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE - 1);

                const { data: users, count } = await query;

                if (!users || users.length === 0) {
                    document.getElementById('usersTable').innerHTML = `<tr><td colspan="6" class="empty-state">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    document.getElementById('usersPagination').innerHTML = '';
                    hideLoading();
                    return;
                }

            const roleText = { customer: 'ê³ ê°', accountant: 'íšŒê³„ì‚¬', admin: 'ê´€ë¦¬ì' };

            document.getElementById('usersTable').innerHTML = users.map(u => `
                <tr>
                    <td>${esc(u.name || '-')}</td>
                    <td>${esc(u.email)}</td>
                    <td><span class="status-badge status-${u.role === 'admin' ? 'rejected' : u.role === 'accountant' ? 'processing' : 'progress'}">${roleText[u.role] || esc(u.role)}</span></td>
                    <td>${u.is_active !== false ? '<span style="color:#059669;font-weight:600;">í™œì„±</span>' : '<span style="color:#6B7280;font-weight:600;">ë¹„í™œì„±</span>'}</td>
                    <td>${formatDate(u.created_at)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="showEditUserModal('${escAttr(u.user_id)}')">í¸ì§‘</button>
                    </td>
                </tr>
            `).join('');

                renderPagination('usersPagination', count, currentPage, 'loadUsers');
            } finally {
                hideLoading();
            }
        }

        function showAddUserModal() {
            const bodyHtml = `
                <div class="form-group">
                    <label>ì´ë©”ì¼ *</label>
                    <input type="email" id="newUserEmail" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>ì´ë¦„ *</label>
                    <input type="text" id="newUserName" placeholder="í™ê¸¸ë™">
                </div>
                <div class="form-group">
                    <label>ì—­í•  *</label>
                    <select id="newUserRole">
                        <option value="customer">ê³ ê°</option>
                        <option value="accountant">íšŒê³„ì‚¬</option>
                        <option value="admin">ê´€ë¦¬ì</option>
                    </select>
                </div>
            `;

            const footerHtml = `
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="addUser()">ì¶”ê°€</button>
            `;

            showModal('ì‚¬ìš©ì ì¶”ê°€', bodyHtml, footerHtml);
        }

        async function addUser() {
            const email = document.getElementById('newUserEmail').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('newUserRole').value;

            if (!email || !name) {
                showToast('ì´ë©”ì¼ê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const { error } = await supabase
                .from('users')
                .insert({
                    email: email,
                    name: name,
                    role: role,
                    is_active: true
                });

            if (error) {
                showToast('ì‚¬ìš©ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
                return;
            }

            showToast('ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal();
            loadUsers();
        }

        async function showEditUserModal(userId) {
            const { data: user } = await supabase
                .from('users')
                .select('*')
                .eq('user_id', userId)
                .single();

            if (!user) { showToast('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }

            const bodyHtml = `
                <dl class="info-grid">
                    <dt>ì´ë©”ì¼</dt><dd>${esc(user.email)}</dd>
                    <dt>ê°€ì…ì¼</dt><dd>${formatDate(user.created_at)}</dd>
                </dl>
                <hr style="margin:20px 0;border:none;border-top:1px solid #E5E7EB;">
                <div class="form-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="editUserName" value="${escAttr(user.name || '')}">
                </div>
                <div class="form-group">
                    <label>ì—­í• </label>
                    <select id="editUserRole">
                        <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>ê³ ê°</option>
                        <option value="accountant" ${user.role === 'accountant' ? 'selected' : ''}>íšŒê³„ì‚¬</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ê´€ë¦¬ì</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>í™œì„± ìƒíƒœ</label>
                    <select id="editUserActive">
                        <option value="true" ${user.is_active !== false ? 'selected' : ''}>í™œì„±</option>
                        <option value="false" ${user.is_active === false ? 'selected' : ''}>ë¹„í™œì„±</option>
                    </select>
                </div>
            `;

            const footerHtml = `
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveUser('${escAttr(userId)}')">ì €ì¥</button>
            `;

            showModal('ì‚¬ìš©ì í¸ì§‘ - ' + esc(user.name || user.email), bodyHtml, footerHtml);
        }

        async function saveUser(userId) {
            const name = document.getElementById('editUserName').value.trim();
            const role = document.getElementById('editUserRole').value;
            const isActive = document.getElementById('editUserActive').value === 'true';

            const { error } = await supabase
                .from('users')
                .update({ name, role, is_active: isActive })
                .eq('user_id', userId);

            if (error) {
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + error.message);
                return;
            }

            showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal();
            loadUsers();
        }

        // ==================== CSV ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜ë“¤ ====================
        async function exportProjects() {
            showLoading();
            try {
                const { data } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
                hideLoading();
                if (!data) { showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                exportToCSV(data, 'projects', [
                    { label: 'ID', key: 'project_id' },
                    { label: 'íšŒì‚¬ëª…(í•œê¸€)', key: 'company_name_kr' },
                    { label: 'íšŒì‚¬ëª…(ì˜ë¬¸)', key: 'company_name' },
                    { label: 'í‰ê°€ë²•', key: 'valuation_method' },
                    { label: 'ìƒíƒœ', key: 'status' },
                    { label: 'ë‹´ë‹¹íšŒê³„ì‚¬', key: 'assigned_accountant' },
                    { label: 'ìŠ¹ì¸ê¸ˆì•¡', key: 'agreed_price' },
                    { label: 'ì„ ê¸ˆì•¡', key: 'deposit_amount' },
                    { label: 'í˜„ì¬ë‹¨ê³„', key: 'current_step' },
                    { label: 'ìƒì„±ì¼', key: 'created_at' }
                ]);
            } catch (error) {
                hideLoading();
                showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        async function exportPayments() {
            showLoading();
            try {
                const { data } = await supabase.from('balance_payments').select('*').order('created_at', { ascending: false });
                hideLoading();
                if (!data) { showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                exportToCSV(data, 'payments', [
                    { label: 'ID', key: 'id' },
                    { label: 'í”„ë¡œì íŠ¸ID', key: 'project_id' },
                    { label: 'í‰ê°€ë²•', key: 'method' },
                    { label: 'ì…ê¸ˆìëª…', key: 'depositor_name' },
                    { label: 'ê¸ˆì•¡', key: 'amount' },
                    { label: 'ì€í–‰', key: 'bank_name' },
                    { label: 'ê³„ì¢Œë²ˆí˜¸', key: 'account_number' },
                    { label: 'ìƒíƒœ', key: 'status' },
                    { label: 'ìš”ì²­ì', key: 'requested_name' },
                    { label: 'í™•ì¸ì¼', key: 'confirmed_at' },
                    { label: 'ìƒì„±ì¼', key: 'created_at' }
                ]);
            } catch (error) {
                hideLoading();
                showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        async function exportRevisions() {
            showLoading();
            try {
                const { data } = await supabase.from('revision_requests').select('*').order('created_at', { ascending: false });
                hideLoading();
                if (!data) { showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                exportToCSV(data, 'revisions', [
                    { label: 'ID', key: 'id' },
                    { label: 'í”„ë¡œì íŠ¸ID', key: 'project_id' },
                    { label: 'í‰ê°€ë²•', key: 'method' },
                    { label: 'ì„¹ì…˜', key: 'section' },
                    { label: 'ìœ í˜•', key: 'request_type' },
                    { label: 'ìš”ì²­ë‚´ìš©', key: 'request_detail' },
                    { label: 'ìƒíƒœ', key: 'status' },
                    { label: 'ìƒì„±ì¼', key: 'created_at' }
                ]);
            } catch (error) {
                hideLoading();
                showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        async function exportDeliveries() {
            showLoading();
            try {
                const { data } = await supabase.from('report_delivery_requests').select('*').order('created_at', { ascending: false });
                hideLoading();
                if (!data) { showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                exportToCSV(data, 'deliveries', [
                    { label: 'ID', key: 'id' },
                    { label: 'í”„ë¡œì íŠ¸ID', key: 'project_id' },
                    { label: 'í‰ê°€ë²•', key: 'method' },
                    { label: 'ìˆ˜ë ¹ìœ í˜•', key: 'delivery_type' },
                    { label: 'ì´ë©”ì¼', key: 'email' },
                    { label: 'ìˆ˜ë ¹ì¸', key: 'recipient_name' },
                    { label: 'ì—°ë½ì²˜', key: 'recipient_phone' },
                    { label: 'ì£¼ì†Œ', key: 'address' },
                    { label: 'ìƒíƒœ', key: 'status' },
                    { label: 'ìš”ì²­ì¼', key: 'requested_at' },
                    { label: 'ì™„ë£Œì¼', key: 'completed_at' }
                ]);
            } catch (error) {
                hideLoading();
                showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        async function exportUsers() {
            showLoading();
            try {
                const { data } = await supabase.from('users').select('*').order('created_at', { ascending: false });
                hideLoading();
                if (!data) { showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                exportToCSV(data, 'users', [
                    { label: 'ID', key: 'user_id' },
                    { label: 'ì´ë¦„', key: 'name' },
                    { label: 'ì´ë©”ì¼', key: 'email' },
                    { label: 'ì—­í• ', key: 'role' },
                    { label: 'í™œì„±', key: 'is_active' },
                    { label: 'ìƒì„±ì¼', key: 'created_at' }
                ]);
            } catch (error) {
                hideLoading();
                showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ==================== í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ====================
        window.addEventListener('keydown', (e) => {
            // Esc: ëª¨ë‹¬ ë‹«ê¸°
            if (e.key === 'Escape') {
                const modal = document.getElementById('modalOverlay');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }

            // Ctrl + 1~6: íƒ­ ì „í™˜
            if (e.ctrlKey && !e.shiftKey && !e.altKey && !e.metaKey) {
                const tabMap = {
                    '1': 'dashboard',
                    '2': 'projects',
                    '3': 'payments',
                    '4': 'revisions',
                    '5': 'delivery',
                    '6': 'users'
                };

                if (tabMap[e.key]) {
                    e.preventDefault();
                    const tabName = tabMap[e.key];
                    const buttons = document.querySelectorAll('.tab-btn');
                    const tabIndex = Object.keys(tabMap).indexOf(e.key);
                    const btn = buttons[tabIndex];
                    if (btn) switchTab(tabName, btn);
                }
            }
        });
    </script>
</body>
</html>
