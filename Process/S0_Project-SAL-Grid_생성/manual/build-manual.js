/**
 * build-manual.js
 *
 * manual_template.mdì˜ INCLUDE í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ êµì²´í•˜ì—¬
 * PROJECT_SAL_GRID_MANUAL.mdë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * ì‚¬ìš©ë²•:
 *   node build-manual.js
 *
 * í”Œë ˆì´ìŠ¤í™€ë” í˜•ì‹:
 *   <!-- INCLUDE: path/to/file.md -->
 *
 * ê²½ë¡œëŠ” í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œì…ë‹ˆë‹¤.
 * ì˜ˆ: <!-- INCLUDE: .claude/rules/01_file-naming.md -->
 */

const fs = require('fs');
const path = require('path');

// í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ (S0_Project-SAL-Grid_ìƒì„±/manualì—ì„œ 2ë‹¨ê³„ ìœ„)
const PROJECT_ROOT = path.resolve(__dirname, '..', '..');

// íŒŒì¼ ê²½ë¡œ
const TEMPLATE_PATH = path.join(__dirname, 'manual_template.md');
const OUTPUT_PATH = path.join(__dirname, 'PROJECT_SAL_GRID_MANUAL.md');

// INCLUDE íŒ¨í„´: <!-- INCLUDE: path/to/file.md -->
const INCLUDE_PATTERN = /<!-- INCLUDE: (.+?) -->/g;

/**
 * INCLUDE í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì²˜ë¦¬í•˜ì—¬ íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ êµì²´
 */
function processIncludes(content) {
    let processed = content;
    let match;
    const errors = [];

    // ëª¨ë“  INCLUDE í”Œë ˆì´ìŠ¤í™€ë” ì°¾ê¸°
    while ((match = INCLUDE_PATTERN.exec(content)) !== null) {
        const placeholder = match[0];
        const relativePath = match[1].trim();
        const absolutePath = path.join(PROJECT_ROOT, relativePath);

        try {
            if (fs.existsSync(absolutePath)) {
                const fileContent = fs.readFileSync(absolutePath, 'utf-8');

                // í—¤ë” ì œê±° ì˜µì…˜ (íŒŒì¼ ì‹œì‘ì´ # ìœ¼ë¡œ ì‹œì‘í•˜ë©´ ì²« ì¤„ ì œê±°)
                // ì´ë ‡ê²Œ í•˜ë©´ rules/ íŒŒì¼ì˜ ì œëª©ì´ ë§¤ë‰´ì–¼ì— ì¤‘ë³µë˜ì§€ ì•ŠìŒ
                const lines = fileContent.split('\n');
                let includedContent = fileContent;

                // ì²« ë²ˆì§¸ ì¤„ì´ # ìœ¼ë¡œ ì‹œì‘í•˜ë©´ ì œê±° (ì„ íƒì )
                // if (lines[0] && lines[0].startsWith('# ')) {
                //     includedContent = lines.slice(1).join('\n');
                // }

                processed = processed.replace(placeholder, includedContent);
                console.log(`âœ… Included: ${relativePath}`);
            } else {
                errors.push(`âŒ File not found: ${relativePath}`);
                // íŒŒì¼ì´ ì—†ìœ¼ë©´ ê²½ê³  ë©”ì‹œì§€ë¡œ ëŒ€ì²´
                processed = processed.replace(
                    placeholder,
                    `<!-- âš ï¸ INCLUDE ERROR: File not found - ${relativePath} -->`
                );
            }
        } catch (err) {
            errors.push(`âŒ Error reading ${relativePath}: ${err.message}`);
            processed = processed.replace(
                placeholder,
                `<!-- âš ï¸ INCLUDE ERROR: ${err.message} -->`
            );
        }
    }

    return { content: processed, errors };
}

/**
 * ë¹Œë“œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
 */
function addBuildTimestamp(content) {
    const timestamp = new Date().toISOString().split('T')[0];
    const buildNote = `<!-- ğŸ”„ Auto-generated from manual_template.md on ${timestamp} -->\n<!-- Do not edit this file directly. Edit manual_template.md instead. -->\n\n`;
    return buildNote + content;
}

/**
 * ë©”ì¸ ë¹Œë“œ í•¨ìˆ˜
 */
function buildManual() {
    console.log('ğŸ“– Building PROJECT_SAL_GRID_MANUAL.md...\n');

    // í…œí”Œë¦¿ íŒŒì¼ í™•ì¸
    if (!fs.existsSync(TEMPLATE_PATH)) {
        console.error('âŒ Template file not found:', TEMPLATE_PATH);
        console.log('\nğŸ’¡ Hint: Create manual_template.md first with INCLUDE placeholders.');
        process.exit(1);
    }

    // í…œí”Œë¦¿ ì½ê¸°
    const template = fs.readFileSync(TEMPLATE_PATH, 'utf-8');

    // INCLUDE ì²˜ë¦¬
    const { content: processed, errors } = processIncludes(template);

    // ë¹Œë“œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    const final = addBuildTimestamp(processed);

    // ê²°ê³¼ ì €ì¥
    fs.writeFileSync(OUTPUT_PATH, final, 'utf-8');

    console.log(`\nğŸ“„ Output: ${OUTPUT_PATH}`);

    // ì—ëŸ¬ ì¶œë ¥
    if (errors.length > 0) {
        console.log('\nâš ï¸ Errors/Warnings:');
        errors.forEach(err => console.log(`   ${err}`));
    }

    // í†µê³„
    const includeCount = (template.match(INCLUDE_PATTERN) || []).length;
    console.log(`\nğŸ“Š Statistics:`);
    console.log(`   - INCLUDE placeholders processed: ${includeCount}`);
    console.log(`   - Errors: ${errors.length}`);

    console.log('\nâœ… Build complete!');
}

// ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
buildManual();
